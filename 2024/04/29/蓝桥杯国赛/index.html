<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>蓝桥杯国赛 - 勇敢梧桐树</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="勇敢梧桐树"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="勇敢梧桐树"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="前作：二战蓝桥杯 建议读者先阅读前作写的模板，再来看后续内容。当然，本作仍然会整理前作模板，可能还会做一些调整。 致谢 感谢天地，感谢父母，感谢环境 特别地，感谢zhj（英雄豪杰！）和lfy（膜拜大佬！）的关键性支持！感谢考场里带了万用表的选手！"><meta property="og:type" content="blog"><meta property="og:title" content="蓝桥杯国赛"><meta property="og:url" content="https://jensentsts.github.io/2024/04/29/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%9B%BD%E8%B5%9B/"><meta property="og:site_name" content="勇敢梧桐树"><meta property="og:description" content="前作：二战蓝桥杯 建议读者先阅读前作写的模板，再来看后续内容。当然，本作仍然会整理前作模板，可能还会做一些调整。 致谢 感谢天地，感谢父母，感谢环境 特别地，感谢zhj（英雄豪杰！）和lfy（膜拜大佬！）的关键性支持！感谢考场里带了万用表的选手！"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://jensentsts.github.io/img/og_image.png"><meta property="article:published_time" content="2024-04-29T11:32:22.000Z"><meta property="article:modified_time" content="2024-05-30T08:34:33.307Z"><meta property="article:author" content="勇敢梧桐树"><meta property="article:tag" content="嵌入式"><meta property="article:tag" content="笔记"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://jensentsts.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://jensentsts.github.io/2024/04/29/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%9B%BD%E8%B5%9B/"},"headline":"蓝桥杯国赛","image":["https://jensentsts.github.io/img/og_image.png"],"datePublished":"2024-04-29T11:32:22.000Z","dateModified":"2024-05-30T08:34:33.307Z","author":{"@type":"Person","name":"勇敢梧桐树"},"publisher":{"@type":"Organization","name":"勇敢梧桐树","logo":{"@type":"ImageObject","url":"https://jensentsts.github.io/img/logo.svg"}},"description":"前作：二战蓝桥杯 建议读者先阅读前作写的模板，再来看后续内容。当然，本作仍然会整理前作模板，可能还会做一些调整。 致谢 感谢天地，感谢父母，感谢环境 特别地，感谢zhj（英雄豪杰！）和lfy（膜拜大佬！）的关键性支持！感谢考场里带了万用表的选手！"}</script><link rel="canonical" href="https://jensentsts.github.io/2024/04/29/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%9B%BD%E8%B5%9B/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css"><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="勇敢梧桐树" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">目录</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2024-04-29T11:32:22.000Z" title="2024/4/29 19:32:22">2024-04-29</time>发表</span><span class="level-item"><time dateTime="2024-05-30T08:34:33.307Z" title="2024/5/30 16:34:33">2024-05-30</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/">嵌入式</a></span><span class="level-item">1 小时读完 (大约13233个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">蓝桥杯国赛</h1><div class="content"><p>前作：<a href="https://jensentsts.github.io/2024/03/21/%E4%BA%8C%E6%88%98%E8%93%9D%E6%A1%A5%E6%9D%AF/">二战蓝桥杯</a></p>
<p>建议读者先阅读前作写的模板，再来看后续内容。当然，本作仍然会整理前作模板，可能还会做一些调整。</p>
<h1 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h1><ul>
<li>感谢天地，感谢父母，感谢环境</li>
<li>特别地，感谢<code>zhj</code>（英雄豪杰！）和<code>lfy</code>（膜拜大佬！）的关键性支持！感谢考场里带了万用表的选手！</li>
</ul>
<span id="more"></span>
<h1 id="省赛回顾"><a href="#省赛回顾" class="headerlink" title="省赛回顾"></a>省赛回顾</h1><h2 id="比赛前"><a href="#比赛前" class="headerlink" title="比赛前"></a>比赛前</h2><p>首先，我遇到了一个大麻烦：我没看准考证上的考场，以为今年比赛还在我去年在的那个地方，直到早上起来看了一眼……我抓紧打车前往考场，300元没了，40+元又没了。</p>
<h2 id="比赛时"><a href="#比赛时" class="headerlink" title="比赛时"></a>比赛时</h2><p>近来被考研英语折磨，用英语做标题，别介意。</p>
<h3 id="To-begin-with"><a href="#To-begin-with" class="headerlink" title="To begin with"></a>To begin with</h3><article class="message is-note">
        
        <div class="message-body">
            <p>这个问题发生在我首次按下<code>Translate</code>时。</p>

        </div>
    </article>
<p><strong>问题描述</strong>：要命了，P4引脚未定义？！我发现我的标准库里（IAPxxxxxxxx.h的、51和52的）没有P4寄存器！！！当时我还以为我需要用IAPxxxxxxx.h这个库呢，点开官方的手册，发现兼容51，抓紧换成stc51的库，结果不行；换成52的看看能不能糊弄？发现也不行。</p>
<p><strong>原因</strong>：可能是，考场上我阴差阳错地记错了，忘记了我的板子上的芯片是什么类型的，然后就找不到目标单片机类型，进而根本解决不了P4不存在的难题。</p>
<p><strong>解决</strong>：在STC-ISP.exe（就是烧录软件、能计算时钟延时数据的那个），点击“头文件”，复制里面的全部代码，新建了一个文件，删掉原来的头文件include，改用新建的文件。</p>
<p><strong>正常状态</strong>：应该使用STC15或者STC89C51新建工程。</p>
<h3 id="Taking-a-further-step"><a href="#Taking-a-further-step" class="headerlink" title="Taking a further step"></a>Taking a further step</h3><p><strong>问题描述</strong>：正常写代码，基本框架和题目中的主要逻辑写好了，编译未通过，<code>Size limitation</code>。</p>
<p><strong>原因</strong>：举办方的锅，破解没有成功。</p>
<p><strong>解决</strong>：压根儿没慌，淡定地告诉巡场老师。</p>
<h3 id="Eventually"><a href="#Eventually" class="headerlink" title="Eventually"></a>Eventually</h3><p><strong>问题描述</strong>：没有万用表，不知道电压输出得对不对。</p>
<p><strong>原因</strong>：我没有，也没找人借，找人借的时候已经有点儿晚了。</p>
<p><strong>解决</strong>：特地争取了一下监考员的同意，然后找前面的大哥借了一下。</p>
<p>得亏咱借了一下，发现电压输出的计算表达式写错了。我连直线的表达式都写不对，考场上还得现推……（我就这？我还去考研的……）</p>
<h3 id="Alongside"><a href="#Alongside" class="headerlink" title="Alongside"></a>Alongside</h3><p>我有个习惯，去年也是如此：出门上厕所的时候，记得切回桌面。（任务栏的点击右下角即可）</p>
<h1 id="代码风格"><a href="#代码风格" class="headerlink" title="代码风格"></a>代码风格</h1><p>几乎没有哪个教程特别强调代码风格的，然而养成习惯的代风将为你提供强大的助力。</p>
<p>对于这样的一个“水赛”（民间称谓哦，不是我起的），一个朴素的建议是，我们最好不要去切换什么大小写，直接全部小写+下划线就可以了。名称尽量用自己看很多遍都不会犯迷糊的，比如赛题里面起了什么名字，这个时候可以用拼音的。当然如果英语过关，那就翻译成英语，在码代码时这会让人赏心悦目。</p>
<p>举个例子吧：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> attach(...) <span class="comment">// ...</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> detain(...) <span class="comment">// ...</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> write(...) <span class="comment">// ...</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> write_led(...) <span class="comment">// 叫led_write也不错，不过这时候推荐将它放到led那一堆代码里去</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> led_on(...) <span class="comment">// ...</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> led_off(...) <span class="comment">// ...</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> led_invert(...) <span class="comment">// ...</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">interface_hui_xian</span><span class="params">()</span> &#123;     <span class="comment">// 回显</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>全部小写、试用下划线的一个使用例。这就是我的习惯，按你的习惯来就好。</p>
<h1 id="新的资源"><a href="#新的资源" class="headerlink" title="新的资源"></a>新的资源</h1><h2 id="ds18b20勘误"><a href="#ds18b20勘误" class="headerlink" title="ds18b20勘误"></a>ds18b20勘误</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">float</span> <span class="title function_">temper_read</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">uint16_t</span> res = <span class="number">0</span>;</span><br><span class="line">	<span class="type">uint8_t</span> high, low;</span><br><span class="line">	</span><br><span class="line">	init_ds18b20();</span><br><span class="line">	Write_DS18B20(<span class="number">0xCC</span>);</span><br><span class="line">	Write_DS18B20(<span class="number">0x44</span>);</span><br><span class="line">	<span class="comment">//Delay_OneWire(100);	// 200ns or more: it doesn&#x27;t work.</span></span><br><span class="line">	</span><br><span class="line">	init_ds18b20();</span><br><span class="line">	Write_DS18B20(<span class="number">0xCC</span>);</span><br><span class="line">	Write_DS18B20(<span class="number">0xBE</span>);</span><br><span class="line">	<span class="comment">//Delay_OneWire(100);</span></span><br><span class="line">	</span><br><span class="line">	low = Read_DS18B20();</span><br><span class="line">	high = Read_DS18B20();</span><br><span class="line">	</span><br><span class="line">	res = high; <span class="comment">// &amp; 0x0F;</span></span><br><span class="line">	res = (res &lt;&lt; <span class="number">8</span>) | low;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> res * <span class="number">0.0625f</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<article class="message is-warning">
        <div class="message-header"><p>注意！</p>
</div>
        <div class="message-body">
            <p>去年写的两个Delay_OneWire(200);会导致无法获取温度！不知道是为什么，换用更短的延时或者是两个Delay_OneWire删掉就可以了。我推荐的做法是以后都不写Delay_OneWire。</p>

        </div>
    </article>
<h2 id="特殊的按键扫描办法"><a href="#特殊的按键扫描办法" class="headerlink" title="特殊的按键扫描办法"></a>特殊的按键扫描办法</h2><p>这里我给出了两种按键检测模式</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 独立按键模式</span></span><br><span class="line"><span class="comment">// 4个引脚分别检测，不用switch</span></span><br><span class="line">u8 <span class="title function_">keys_btn</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	P30 = <span class="number">1</span>;</span><br><span class="line">	delay_100us();</span><br><span class="line">	<span class="keyword">if</span> (P30 == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	P31 = <span class="number">1</span>;</span><br><span class="line">	delay_100us();</span><br><span class="line">	<span class="keyword">if</span> (P31 == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	P32 = <span class="number">1</span>;</span><br><span class="line">	delay_100us();</span><br><span class="line">	<span class="keyword">if</span> (P32 == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">9</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	P33 = <span class="number">1</span>;</span><br><span class="line">	delay_100us();</span><br><span class="line">	<span class="keyword">if</span> (P33 == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">13</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 只扫描S4 S5 S8 S9</span></span><br><span class="line"><span class="comment">// 低四位和高四位分别表示按键的行坐标和列坐标，置零位的位数的表示按键的相应的坐标</span></span><br><span class="line"><span class="comment">// 例如按下S8，则应该返回0xB7</span></span><br><span class="line"><span class="comment">// 按下S8 &amp; S9，应该返回0x3B</span></span><br><span class="line"><span class="comment">// 支持多点按键，</span></span><br><span class="line">u8 <span class="title function_">keys_scan_4589</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	u8 temp = <span class="number">0xFF</span>;</span><br><span class="line">	P32 = <span class="number">1</span>; P33 = <span class="number">0</span>;</span><br><span class="line">	P42 = <span class="number">0</span>; P44 = <span class="number">0</span>;</span><br><span class="line">	delay_100us();</span><br><span class="line">	<span class="keyword">if</span> (P32 == <span class="number">0</span>) &#123;</span><br><span class="line">		temp &amp;= <span class="number">0xFB</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	P32 = <span class="number">0</span>; P33 = <span class="number">1</span>;</span><br><span class="line">	<span class="comment">// P42 = 0; P44 = 0;</span></span><br><span class="line">	delay_100us();</span><br><span class="line">	<span class="keyword">if</span> (P33 == <span class="number">0</span>) &#123;</span><br><span class="line">		temp &amp;= <span class="number">0xF7</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	P32 = <span class="number">0</span>; P33 = <span class="number">0</span>;</span><br><span class="line">	P42 = <span class="number">1</span>; P44 = <span class="number">0</span>;</span><br><span class="line">	delay_100us();</span><br><span class="line">	<span class="keyword">if</span> (P42 == <span class="number">0</span>) &#123;</span><br><span class="line">		temp &amp;= <span class="number">0xBF</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// P32 = 0; P33 = 0;</span></span><br><span class="line">	P42 = <span class="number">0</span>; P44 = <span class="number">1</span>;</span><br><span class="line">	delay_100us();</span><br><span class="line">	<span class="keyword">if</span> (P44 == <span class="number">0</span>) &#123;</span><br><span class="line">		temp &amp;= <span class="number">0x7F</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> temp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="串口通讯"><a href="#串口通讯" class="headerlink" title="串口通讯"></a>串口通讯</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="超声波"><a href="#超声波" class="headerlink" title="超声波"></a>超声波</h2><p>前作已经实现过一次，但是本作将重新审视其代码、逻辑以及其他的需求。重新敲一遍有关代码。</p>
<p>P.S. 前作的代码可能无法正常工作，请以本作为准。</p>
<p>文章参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/boybs/article/details/122578011">【蓝桥杯单片机进阶强化-05】超声波测距</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//////////////////////////////////////////////////////////////</span></span><br><span class="line">sbit TX = P1^<span class="number">0</span>;</span><br><span class="line">sbit RX = P1^<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sonic_send_signal</span><span class="params">()</span> &#123;</span><br><span class="line">	u8 i;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; ++i) &#123;</span><br><span class="line">		TX = <span class="number">1</span>;</span><br><span class="line">		_nop_();_nop_();_nop_();_nop_();_nop_();_nop_();_nop_();_nop_(); <span class="comment">// 8个 _nop_();</span></span><br><span class="line">		TX = <span class="number">0</span>;</span><br><span class="line">		_nop_();_nop_();_nop_();_nop_();_nop_();_nop_();_nop_();_nop_();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">u16 <span class="title function_">sonic_get_dist</span><span class="params">()</span> &#123;</span><br><span class="line">	u16 tim;			<span class="comment">// 计数时间</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// AUXR &amp;= 0xFB; // 不用它</span></span><br><span class="line">	TMOD &amp;= <span class="number">0xF0</span>;</span><br><span class="line">	TF0 = <span class="number">0</span>;</span><br><span class="line">	TH0 = <span class="number">0x00</span>;				<span class="comment">// 计数器初始化</span></span><br><span class="line">	TL0 = <span class="number">0x00</span>;</span><br><span class="line">	sonic_send_signal();</span><br><span class="line">	TR0 = <span class="number">1</span>;				<span class="comment">// 开始计数</span></span><br><span class="line">	<span class="keyword">while</span> ( (RX == <span class="number">1</span>) &amp;&amp; (TF0 == <span class="number">0</span>) ); 	<span class="comment">// 接收到信号时，RX == 1；如果计数器溢出（TF==1）则结束计时。</span></span><br><span class="line">	TR0 = <span class="number">0</span>;				<span class="comment">// 计数结束</span></span><br><span class="line">	<span class="comment">// 当正常接收到信号时</span></span><br><span class="line">	<span class="keyword">if</span> (TF0 == <span class="number">0</span>) &#123;</span><br><span class="line">		tim = TH0;</span><br><span class="line">		tim = (tim &lt;&lt; <span class="number">8</span>) | TL0;</span><br><span class="line">		<span class="keyword">return</span> (u16)(tim * <span class="number">0.017</span>);		<span class="comment">// distance = 0.000001s * 34000 cm/s /  2 = 0.017 cm/s</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 若溢出，中断标志清零，并返回0</span></span><br><span class="line">	TF0 = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="红外"><a href="#红外" class="headerlink" title="红外"></a>红外</h2><p>文章参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43444989/article/details/89302008">【蓝桥杯单片机】红外接收及NEC红外通信协议</a></p>
<article class="message is-warning">
        <div class="message-header"><p>注意！</p>
</div>
        <div class="message-body">
            <ul>
<li>实现红外需要将J2跳线帽全部右移。（超声波和红外共用同一组引脚）</li>
<li>使用红外，无法使用超声波。</li>
</ul>

        </div>
    </article>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="继电器"><a href="#继电器" class="headerlink" title="继电器"></a>继电器</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="刷题"><a href="#刷题" class="headerlink" title="刷题"></a>刷题</h1><h2 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h2><p>和前面的几乎一致，只是对个别标识符的命名稍作调整</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="TH11"><a href="#TH11" class="headerlink" title="TH11"></a>TH11</h2><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;intrins.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;STC15F104E.H&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;iic.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;onewire.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ds1302.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> attach(x, y, z) P25=(x); P26=(y); P27=(z);</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> detach() P27=0; P25=0; P26=0; <span class="comment">// 注意顺序，P27必须在前</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> write(x, y, z, dat) P0 = 0xFF; attach(x, y, z); P0 = (dat); detach();</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> <span class="type">int8_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> <span class="type">uint8_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> <span class="type">uint16_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">uint32_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="type">uint8_t</span> timer_key;</span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="type">uint8_t</span> led_statue = <span class="number">0xFF</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> led_on(index) led_statue &amp;= 0xFF ^ (1 &lt;&lt; (index) ); write(0, 0, 1, led_statue);</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> led_off(index) led_statue |= 1 &lt;&lt; (index); write(0, 0, 1, led_statue);</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> led_invert(index) led_statue ^= 1 &lt;&lt; (index); write(0, 0, 1, led_statue);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_blank 16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_interval 17 <span class="comment">// 间隔符</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_h 18</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_p 19</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_u 20</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_l 21</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_n 22</span></span><br><span class="line"></span><br><span class="line">code <span class="type">uint8_t</span> nt_code[] = &#123;<span class="number">0xc0</span>,<span class="number">0xf9</span>,<span class="number">0xa4</span>,<span class="number">0xb0</span>,<span class="number">0x99</span>,<span class="number">0x92</span>,<span class="number">0x82</span>,<span class="number">0xf8</span>,<span class="number">0x80</span>,<span class="number">0x90</span>,<span class="number">0x88</span>,<span class="number">0x83</span>,<span class="number">0xc6</span>,<span class="number">0xa1</span>,<span class="number">0x86</span>,<span class="number">0x8e</span>,</span><br><span class="line">						  <span class="number">0xFF</span>, <span class="number">0xBF</span>, <span class="number">0x89</span>, <span class="number">0x8C</span>, <span class="number">0xC1</span>, <span class="number">0xC7</span>, <span class="number">0xC8</span>&#125;;</span><br><span class="line"><span class="type">uint8_t</span> nt_buf[<span class="number">8</span>] = &#123;nt_blank, nt_blank, nt_blank, nt_blank, nt_blank, nt_blank, nt_blank, nt_blank&#125;;</span><br><span class="line"><span class="type">uint8_t</span> nt_index;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_show(pos, dat) write(0, 1, 1, (1 &lt;&lt; (pos))); write(1, 1, 1, (nt_code[(dat)]));</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_showdot(pos, dat) write(0, 1, 1, (1 &lt;&lt; (pos))); write(1, 1, 1, (nt_code[(dat)] &amp; 0x7F));</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="type">uint8_t</span> hour, minute, second;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> temper;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> light_volt;</span><br><span class="line"><span class="type">uint8_t</span> light_statue;</span><br><span class="line"></span><br><span class="line"><span class="type">uint8_t</span> param_time;</span><br><span class="line"><span class="type">uint8_t</span> param_temper;</span><br><span class="line"><span class="type">uint8_t</span> param_led;</span><br><span class="line"></span><br><span class="line"><span class="type">uint16_t</span> timer_l3;</span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_ms</span><span class="params">(<span class="type">uint8_t</span> ms)</span> &#123;	<span class="comment">//@12.000MHz</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (ms--) &#123;</span><br><span class="line">		<span class="type">unsigned</span> <span class="type">char</span> data i, j;</span><br><span class="line"></span><br><span class="line">		_nop_();</span><br><span class="line">		_nop_();</span><br><span class="line">		i = <span class="number">12</span>;</span><br><span class="line">		j = <span class="number">168</span>;</span><br><span class="line">		<span class="keyword">do</span> &#123;</span><br><span class="line">			<span class="keyword">while</span> (--j);</span><br><span class="line">		&#125; <span class="keyword">while</span> (--i);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">nt_show_len</span><span class="params">(<span class="type">uint8_t</span> pos, <span class="type">uint32_t</span> dat, <span class="type">uint8_t</span> len)</span> &#123;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		nt_buf[pos] = dat % <span class="number">10</span>;</span><br><span class="line">		dat /= <span class="number">10</span>;</span><br><span class="line">		pos--;</span><br><span class="line">	&#125; <span class="keyword">while</span> (--len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">nt_show_dot</span><span class="params">(<span class="type">uint8_t</span> pos, <span class="type">uint32_t</span> dat, <span class="type">uint8_t</span> len, <span class="type">uint8_t</span> dot_pos)</span> &#123;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (pos == dot_pos) &#123;</span><br><span class="line">			nt_buf[pos] = (dat % <span class="number">10</span>) | <span class="number">0x80</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			nt_buf[pos] = dat % <span class="number">10</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		dat /= <span class="number">10</span>;</span><br><span class="line">		pos--;</span><br><span class="line">	&#125; <span class="keyword">while</span> (--len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">nt_show_blank</span><span class="params">(<span class="type">uint8_t</span> pos, <span class="type">uint32_t</span> dat, <span class="type">uint8_t</span> len)</span> &#123;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		nt_buf[pos] = dat % <span class="number">10</span>;</span><br><span class="line">		dat /= <span class="number">10</span>;</span><br><span class="line">		pos--;</span><br><span class="line">	&#125; <span class="keyword">while</span> (--len &amp;&amp; dat);</span><br><span class="line">	<span class="keyword">while</span> (len--) &#123;</span><br><span class="line">		nt_buf[pos] = nt_blank;</span><br><span class="line">		pos--;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pcf_write</span><span class="params">(<span class="type">uint8_t</span> ctrl, <span class="type">uint8_t</span> dat)</span> &#123;</span><br><span class="line">	IIC_Start();</span><br><span class="line">	IIC_SendByte(<span class="number">0x90</span>);	<span class="comment">// 写地址</span></span><br><span class="line">	IIC_WaitAck();</span><br><span class="line">	IIC_SendByte(ctrl);	<span class="comment">// 控制字</span></span><br><span class="line">	IIC_WaitAck();</span><br><span class="line">	IIC_SendByte(dat);	<span class="comment">// D/A数据</span></span><br><span class="line">	IIC_WaitAck();</span><br><span class="line">	IIC_Stop();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> <span class="title function_">pcf_read</span><span class="params">(<span class="type">uint8_t</span> ctrl)</span> &#123;</span><br><span class="line">	<span class="type">uint8_t</span> res;</span><br><span class="line">	<span class="comment">// 先写入一次，这是因为pcf8591只会在写入之后做一次A/D转换，直接读取将读到上一次转换之后的值。</span></span><br><span class="line">	IIC_Start();</span><br><span class="line">	IIC_SendByte(<span class="number">0x90</span>);	<span class="comment">// 写地址</span></span><br><span class="line">	IIC_WaitAck();</span><br><span class="line">	IIC_SendByte(ctrl);	<span class="comment">// 这里需要确定一下哪个通道要被读取，AIN1是光敏电阻的传感器</span></span><br><span class="line">	IIC_WaitAck();</span><br><span class="line">	IIC_Stop();</span><br><span class="line">	<span class="comment">// 读取数据</span></span><br><span class="line">	IIC_Start();</span><br><span class="line">	IIC_SendByte(<span class="number">0x91</span>);	<span class="comment">// 读地址</span></span><br><span class="line">	IIC_WaitAck();</span><br><span class="line">	res = IIC_RecByte();<span class="comment">// 读取1byte即可</span></span><br><span class="line">	IIC_SendAck(<span class="number">0</span>);</span><br><span class="line">	IIC_Stop();</span><br><span class="line">	<span class="keyword">return</span> res * <span class="number">5.0f</span> / <span class="number">255.0f</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ds1302_r_reg_hour 0x85</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ds1302_w_reg_hour 0x84</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ds1302_r_reg_minute 0x83</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ds1302_w_reg_minute 0x82</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ds1302_r_reg_second 0x81</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ds1302_w_reg_second 0x80</span></span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="type">float</span> <span class="title function_">temper_read</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">uint16_t</span> res = <span class="number">0</span>;</span><br><span class="line">	<span class="type">uint8_t</span> high, low;</span><br><span class="line">	</span><br><span class="line">	init_ds18b20();</span><br><span class="line">	Write_DS18B20(<span class="number">0xCC</span>);</span><br><span class="line">	Write_DS18B20(<span class="number">0x44</span>);</span><br><span class="line">	<span class="comment">//Delay_OneWire(100);	// 200ns or more: it doesn;t work.</span></span><br><span class="line">	</span><br><span class="line">	init_ds18b20();</span><br><span class="line">	Write_DS18B20(<span class="number">0xCC</span>);</span><br><span class="line">	Write_DS18B20(<span class="number">0xBE</span>);</span><br><span class="line">	<span class="comment">//Delay_OneWire(100);</span></span><br><span class="line">	</span><br><span class="line">	low = Read_DS18B20();</span><br><span class="line">	high = Read_DS18B20();</span><br><span class="line">	</span><br><span class="line">	res = high; <span class="comment">// &amp; 0x0F;</span></span><br><span class="line">	res = (res &lt;&lt; <span class="number">8</span>) | low;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> res * <span class="number">0.0625f</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">e2prom_write</span><span class="params">(<span class="type">uint8_t</span> addr, <span class="type">uint8_t</span>* dat, <span class="type">uint8_t</span> len)</span> &#123;</span><br><span class="line">	IIC_Start();</span><br><span class="line">	IIC_SendByte(<span class="number">0xA0</span>);	<span class="comment">// Write Address</span></span><br><span class="line">	IIC_WaitAck();</span><br><span class="line">	IIC_SendByte(addr);</span><br><span class="line">	IIC_WaitAck();</span><br><span class="line">	<span class="keyword">while</span> (len--) &#123;</span><br><span class="line">		IIC_SendByte(dat[len]);</span><br><span class="line">		IIC_WaitAck();</span><br><span class="line">	&#125;</span><br><span class="line">	IIC_Stop();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">e2prom_read</span><span class="params">(<span class="type">uint8_t</span> addr, <span class="type">uint8_t</span>* dat, <span class="type">uint8_t</span> len)</span> &#123;</span><br><span class="line">	<span class="type">uint8_t</span> i;</span><br><span class="line">	IIC_Start();</span><br><span class="line">	IIC_SendByte(<span class="number">0xA0</span>);	<span class="comment">// Write Address</span></span><br><span class="line">	IIC_WaitAck();</span><br><span class="line">	IIC_SendByte(addr);</span><br><span class="line">	IIC_WaitAck();</span><br><span class="line">	</span><br><span class="line">	IIC_Start();	<span class="comment">// Restart</span></span><br><span class="line">	IIC_SendByte(<span class="number">0xA1</span>);	<span class="comment">// Read Address</span></span><br><span class="line">	IIC_WaitAck();</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; ++i) &#123;</span><br><span class="line">		dat[i] = IIC_RecByte();</span><br><span class="line">		IIC_SendAck(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">sbit TX = P1^<span class="number">0</span>;</span><br><span class="line">sbit RX = P1^<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sonic_send_signal</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">uint8_t</span> i;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; ++i) &#123;</span><br><span class="line">		TX = <span class="number">1</span>;</span><br><span class="line">		_nop_();_nop_();_nop_();_nop_();_nop_();_nop_();_nop_();_nop_(); <span class="comment">// 8个 _nop_();</span></span><br><span class="line">		TX = <span class="number">0</span>;</span><br><span class="line">		_nop_();_nop_();_nop_();_nop_();_nop_();_nop_();_nop_();_nop_();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint8_t</span> <span class="title function_">sonic_get_dist</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">uint16_t</span> tim;			<span class="comment">// 计数时间</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// AUXR &amp;= 0xFB;</span></span><br><span class="line">	<span class="comment">// TMOD &amp;= 0xF0;</span></span><br><span class="line">	TF0 = <span class="number">0</span>;</span><br><span class="line">	TH0 = <span class="number">0x00</span>;				<span class="comment">// 计数器初始化</span></span><br><span class="line">	TL0 = <span class="number">0x00</span>;</span><br><span class="line">	sonic_send_signal();</span><br><span class="line">	TR0 = <span class="number">1</span>;				<span class="comment">// 开始计数</span></span><br><span class="line">	<span class="keyword">while</span> ( (RX == <span class="number">1</span>) &amp;&amp; (TF0 == <span class="number">0</span>) ); 	<span class="comment">// 接收到信号时，RX == 1；如果计数器溢出（TF==1）则结束计时。</span></span><br><span class="line">	TR0 = <span class="number">0</span>;				<span class="comment">// 计数结束</span></span><br><span class="line">	<span class="comment">// 当正常接收到信号时</span></span><br><span class="line">	<span class="keyword">if</span> (TF0 == <span class="number">0</span>) &#123;</span><br><span class="line">		tim = TH0;</span><br><span class="line">		tim = (tim &lt;&lt; <span class="number">8</span>) | TL0;</span><br><span class="line">		<span class="keyword">return</span> (<span class="type">uint8_t</span>)(tim * <span class="number">0.017</span>);		<span class="comment">// distance = 0.000001s * 34000 cm/s /  2 = 0.017 cm/s</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 若溢出，中断标志清零，并返回0</span></span><br><span class="line">	TF0 = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="type">uint8_t</span> <span class="title function_">keys_scan</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">uint8_t</span> temp = <span class="number">0x00</span>;</span><br><span class="line">	P3 = <span class="number">0x30</span>; P42 = <span class="number">1</span>; P44 = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span> (P3 != <span class="number">0x0C</span> || P42 != <span class="number">0</span> || P44 != <span class="number">0</span>) &#123;</span><br><span class="line">		temp = P3 | (<span class="type">uint8_t</span>)P42 &lt;&lt; <span class="number">6</span> | (<span class="type">uint8_t</span>)P44 &lt;&lt; <span class="number">7</span>;</span><br><span class="line">		<span class="comment">// delay_ms(10);</span></span><br><span class="line">		P3 = <span class="number">0x0F</span>; P42 = <span class="number">0</span>; P44 = <span class="number">0</span>;</span><br><span class="line">		temp |= P3;</span><br><span class="line">		<span class="keyword">switch</span> (temp) &#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0x7E</span>: <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xBE</span>: <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xDE</span>: <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xEE</span>: <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0x7D</span>: <span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xBD</span>: <span class="keyword">return</span> <span class="number">6</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xDD</span>: <span class="keyword">return</span> <span class="number">7</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xED</span>: <span class="keyword">return</span> <span class="number">8</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0x7B</span>: <span class="keyword">return</span> <span class="number">9</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xBB</span>: <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xDB</span>: <span class="keyword">return</span> <span class="number">11</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xEB</span>: <span class="keyword">return</span> <span class="number">12</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0x77</span>: <span class="keyword">return</span> <span class="number">13</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xB7</span>: <span class="keyword">return</span> <span class="number">14</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xD7</span>: <span class="keyword">return</span> <span class="number">15</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xE7</span>: <span class="keyword">return</span> <span class="number">16</span>;</span><br><span class="line">			<span class="keyword">default</span>: <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">timer0_Init</span><span class="params">(<span class="type">void</span>)</span>		<span class="comment">//1000微秒12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">	AUXR |= <span class="number">0x80</span>;			<span class="comment">//定时器时钟1T模式</span></span><br><span class="line">	TMOD &amp;= <span class="number">0xF0</span>;			<span class="comment">//设置定时器模式</span></span><br><span class="line">	TMOD |= <span class="number">0x04</span>;</span><br><span class="line">	TL0 = <span class="number">0xFF</span>;				<span class="comment">//设置定时初值</span></span><br><span class="line">	TH0 = <span class="number">0xFF</span>;				<span class="comment">//设置定时初值</span></span><br><span class="line">	TF0 = <span class="number">0</span>;				<span class="comment">//清除TF0标志</span></span><br><span class="line">	<span class="comment">// TR0 = 1;				//定时器0开始计时</span></span><br><span class="line">	<span class="comment">// ET0 = 1;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">timer1_Init</span><span class="params">(<span class="type">void</span>)</span>		<span class="comment">//1000微秒12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">	AUXR |= <span class="number">0x40</span>;			<span class="comment">//定时器时钟1T模式</span></span><br><span class="line">	TMOD &amp;= <span class="number">0x0F</span>;			<span class="comment">//设置定时器模式</span></span><br><span class="line">	TL1 = <span class="number">0x20</span>;				<span class="comment">//设置定时初始值</span></span><br><span class="line">	TH1 = <span class="number">0xD1</span>;				<span class="comment">//设置定时初始值</span></span><br><span class="line">	TF1 = <span class="number">0</span>;				<span class="comment">//清除TF1标志</span></span><br><span class="line">	TR1 = <span class="number">1</span>;				<span class="comment">//定时器1开始计时</span></span><br><span class="line">	ET1 = <span class="number">1</span>;				<span class="comment">//使能定时器1中断</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="type">uint8_t</span> interface, interface_data, interface_param;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_time</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	nt_show_len(<span class="number">1</span>, hour, <span class="number">2</span>);</span><br><span class="line">	nt_buf[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">	nt_show_len(<span class="number">4</span>, minute, <span class="number">2</span>);</span><br><span class="line">	nt_buf[<span class="number">5</span>] = <span class="number">0</span>;</span><br><span class="line">	nt_show_len(<span class="number">7</span>, second, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_temper</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	nt_buf[<span class="number">0</span>] = <span class="number">0x0F</span>;</span><br><span class="line">	nt_buf[<span class="number">1</span>] = nt_buf[<span class="number">2</span>] = nt_buf[<span class="number">3</span>] = nt_buf[<span class="number">4</span>] = nt_blank;</span><br><span class="line">	nt_show_dot(<span class="number">7</span>, temper * <span class="number">10.0f</span>, <span class="number">3</span>, <span class="number">6</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_light</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	nt_buf[<span class="number">0</span>] = nt_h;</span><br><span class="line">	nt_buf[<span class="number">1</span>] = nt_blank;</span><br><span class="line">	nt_show_dot(<span class="number">4</span>, light_volt * <span class="number">100</span>, <span class="number">3</span>, <span class="number">2</span>);</span><br><span class="line">	nt_buf[<span class="number">5</span>] = nt_buf[<span class="number">6</span>] = nt_blank;</span><br><span class="line">	nt_buf[<span class="number">7</span>] = light_statue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_param_time</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	nt_buf[<span class="number">0</span>] = <span class="number">0x05</span>;	<span class="comment">// S</span></span><br><span class="line">	nt_buf[<span class="number">1</span>] = <span class="number">0x04</span>;</span><br><span class="line">	nt_buf[<span class="number">2</span>] = nt_buf[<span class="number">3</span>] = nt_buf[<span class="number">4</span>] = nt_buf[<span class="number">5</span>] = nt_blank;</span><br><span class="line">	nt_show_len(<span class="number">7</span>, param_time, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_param_temper</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	nt_buf[<span class="number">0</span>] = <span class="number">0x05</span>;	<span class="comment">// S</span></span><br><span class="line">	nt_buf[<span class="number">1</span>] = <span class="number">0x05</span>;</span><br><span class="line">	nt_buf[<span class="number">2</span>] = nt_buf[<span class="number">3</span>] = nt_buf[<span class="number">4</span>] = nt_buf[<span class="number">5</span>] = nt_blank;</span><br><span class="line">	nt_show_len(<span class="number">7</span>, param_temper, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_param_led</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	nt_buf[<span class="number">0</span>] = <span class="number">0x05</span>;	<span class="comment">// S</span></span><br><span class="line">	nt_buf[<span class="number">1</span>] = <span class="number">0x06</span>;</span><br><span class="line">	nt_buf[<span class="number">2</span>] = nt_buf[<span class="number">3</span>] = nt_buf[<span class="number">4</span>] = nt_buf[<span class="number">5</span>] = nt_blank;</span><br><span class="line">	nt_show_len(<span class="number">7</span>, param_led, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="keyword">switch</span> (interface) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">			<span class="keyword">switch</span> (interface_data) &#123;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">					draw_time();</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">					draw_temper();</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">					draw_light();</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">			<span class="keyword">switch</span> (interface_param) &#123;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">					draw_param_time();</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">					draw_param_temper();</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">					draw_param_led();</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// led</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (minute == <span class="number">0</span> &amp;&amp; second == <span class="number">0</span>) &#123;</span><br><span class="line">		led_on(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		led_off(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (temper &lt; param_temper) &#123;</span><br><span class="line">		led_on(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		led_off(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (light_volt &gt; <span class="number">3.3</span>) &#123;		<span class="comment">// 3.3是随便写的，大概取一个中间值就好</span></span><br><span class="line">		led_off(<span class="number">2</span>);</span><br><span class="line">		led_off(<span class="number">3</span>); led_off(<span class="number">4</span>); led_off(<span class="number">5</span>); led_off(<span class="number">6</span>); led_off(<span class="number">7</span>);</span><br><span class="line">		led_on(param_led - <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (timer_l3 &gt;= <span class="number">3000</span>)&#123;</span><br><span class="line">			led_on(<span class="number">2</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		led_off(<span class="number">3</span>); led_off(<span class="number">4</span>); led_off(<span class="number">5</span>); led_off(<span class="number">6</span>); led_off(<span class="number">7</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">key_event</span><span class="params">(<span class="type">uint8_t</span> key)</span> &#123;</span><br><span class="line">	<span class="type">static</span> bit press_flag = <span class="number">0</span>;			<span class="comment">// 用于判断按键是不是刚刚按下——实现一些按键的下降沿触发</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (timer_key &lt; <span class="number">50</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	timer_key = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">switch</span> (key) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">13</span>:	<span class="comment">// S4</span></span><br><span class="line">			<span class="keyword">if</span> (press_flag)	<span class="comment">// 只能是按下的时刻被触发，不能是</span></span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			press_flag = <span class="number">1</span>;	<span class="comment">// 实话说，这种写法是感觉告诉我的，，，一坨史，，，它将在default中被置为0，，，感觉是朴素的小学数学思想所致</span></span><br><span class="line"></span><br><span class="line">			++interface;</span><br><span class="line">			interface %= <span class="number">2</span>;</span><br><span class="line">			interface_data = <span class="number">0</span>;</span><br><span class="line">			interface_param = <span class="number">0</span>;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">			</span><br><span class="line">		<span class="keyword">case</span> <span class="number">9</span>:	<span class="comment">// S5</span></span><br><span class="line">			<span class="keyword">if</span> (press_flag)	<span class="comment">// 只能是按下的时刻被触发，不能是</span></span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			press_flag = <span class="number">1</span>;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span> (interface == <span class="number">0</span>) &#123;</span><br><span class="line">				interface_data++;</span><br><span class="line">				interface_data %= <span class="number">3</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (interface == <span class="number">1</span>) &#123;</span><br><span class="line">				interface_param++;</span><br><span class="line">				interface_param %= <span class="number">3</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">14</span>:	<span class="comment">// S8</span></span><br><span class="line">			<span class="keyword">if</span> (press_flag)	<span class="comment">// 只能是按下的时刻被触发，不能是</span></span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			press_flag = <span class="number">1</span>;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span> (interface == <span class="number">1</span>) &#123;</span><br><span class="line">				<span class="keyword">switch</span> (interface_param) &#123;</span><br><span class="line">					<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">						<span class="keyword">if</span> (param_time &gt; <span class="number">0</span>) &#123;</span><br><span class="line">							param_time--;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">						<span class="keyword">if</span> (param_temper &gt; <span class="number">0</span>) &#123;</span><br><span class="line">							param_temper--;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">						<span class="keyword">if</span> (param_led &gt; <span class="number">4</span>) &#123;</span><br><span class="line">							param_led--;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">			</span><br><span class="line">		<span class="keyword">case</span> <span class="number">10</span>:	<span class="comment">// S9</span></span><br><span class="line">			<span class="keyword">if</span> (press_flag)	<span class="comment">// 只能是按下的时刻被触发，不能是</span></span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			press_flag = <span class="number">1</span>;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span> (interface == <span class="number">1</span>) &#123;</span><br><span class="line">				<span class="keyword">switch</span> (interface_param) &#123;</span><br><span class="line">					<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">						<span class="keyword">if</span> (param_time &lt; <span class="number">23</span>) &#123;</span><br><span class="line">							param_time++;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">						<span class="keyword">if</span> (param_temper &lt; <span class="number">99</span>) &#123;	<span class="comment">// 应该没有评委会把我的温度调到大于99吧，，不会吧，，，但是不放心，还是写上了。</span></span><br><span class="line">							param_temper++;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">						<span class="keyword">if</span> (param_led &lt; <span class="number">8</span>) &#123;</span><br><span class="line">							param_led++;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			press_flag = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">update</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">uint8_t</span> dat;</span><br><span class="line">	</span><br><span class="line">	dat = Read_Ds1302_Byte(ds1302_r_reg_hour) &amp; <span class="number">0x3F</span>;</span><br><span class="line">	hour = (dat &gt;&gt; <span class="number">4</span>) * <span class="number">10</span> + (dat &amp; <span class="number">0x0F</span>);</span><br><span class="line">	dat = Read_Ds1302_Byte(ds1302_r_reg_minute) &amp; <span class="number">0x7F</span>;</span><br><span class="line">	minute = (dat &gt;&gt; <span class="number">4</span>) * <span class="number">10</span> + (dat &amp; <span class="number">0x0F</span>);</span><br><span class="line">	dat = Read_Ds1302_Byte(ds1302_r_reg_second) &amp; <span class="number">0x7F</span>;</span><br><span class="line">	second = (dat &gt;&gt; <span class="number">4</span>) * <span class="number">10</span> + (dat &amp; <span class="number">0x0F</span>);</span><br><span class="line">	</span><br><span class="line">	light_volt = pcf_read(<span class="number">0x41</span>);</span><br><span class="line">	temper = temper_read();</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (light_volt &lt; <span class="number">3.3</span>) &#123;		<span class="comment">// 暗</span></span><br><span class="line">		<span class="keyword">if</span> (timer_l3 == <span class="number">0</span>) &#123;</span><br><span class="line">			timer_l3 = <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (timer_l3 &gt;= <span class="number">4000</span>) &#123;</span><br><span class="line">			timer_l3 = <span class="number">4000</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		light_statue = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		timer_l3 = <span class="number">0</span>;</span><br><span class="line">		light_statue = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	write(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0xFF</span>);</span><br><span class="line">	write(<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0x00</span>);</span><br><span class="line">	write(<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0x00</span>);</span><br><span class="line">	write(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0xFF</span>);</span><br><span class="line"></span><br><span class="line">	init_ds18b20();</span><br><span class="line">	</span><br><span class="line">	pcf_write(<span class="number">0x41</span>, <span class="number">0x00</span>);</span><br><span class="line">	</span><br><span class="line">	timer1_Init();</span><br><span class="line">	</span><br><span class="line">	param_time = <span class="number">17</span>;</span><br><span class="line">	param_temper = <span class="number">25</span>;</span><br><span class="line">	param_led = <span class="number">4</span>;</span><br><span class="line">	</span><br><span class="line">	Write_Ds1302_Byte(ds1302_w_reg_hour, <span class="number">0x16</span>);</span><br><span class="line">	Write_Ds1302_Byte(ds1302_w_reg_minute, <span class="number">0x59</span>);</span><br><span class="line">	Write_Ds1302_Byte(ds1302_w_reg_second, <span class="number">0x50</span>);</span><br><span class="line">	</span><br><span class="line">	EA = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	init();</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		draw();</span><br><span class="line">		update();</span><br><span class="line">		key_event(keys_scan());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">timer0_int</span><span class="params">(<span class="type">void</span>)</span> interrupt 1 &#123;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">timer1_int</span><span class="params">(<span class="type">void</span>)</span> interrupt 3 &#123;</span><br><span class="line">	nt_index %= <span class="number">8</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (nt_buf[nt_index] &amp; <span class="number">0x80</span>) &#123; <span class="comment">// 小数点注记方法：第八位置1</span></span><br><span class="line">		nt_showdot(nt_index, nt_buf[nt_index] &amp; <span class="number">0x7F</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		nt_show(nt_index, nt_buf[nt_index]);</span><br><span class="line">	&#125;</span><br><span class="line">	nt_index++;</span><br><span class="line">	timer_key++;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (timer_l3 != <span class="number">0</span>) &#123;</span><br><span class="line">		timer_l3++;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="TH12"><a href="#TH12" class="headerlink" title="TH12"></a>TH12</h2><h3 id="代码-1"><a href="#代码-1" class="headerlink" title="代码"></a>代码</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;intrins.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;STC15F104E.H&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;iic.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;onewire.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ds1302.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> attach(x, y, z) P25=(x); P26=(y); P27=(z);</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> detach() P27=0; P25=0; P26=0; <span class="comment">// 注意顺序，P27必须在前</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> write(x, y, z, dat) P0 = 0xFF; attach(x, y, z); P0 = (dat); detach();</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> i8;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> u8;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">int</span> i16;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> u16;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> u32;</span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">u8 timer_key;</span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">u8 led_statue = <span class="number">0xFF</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> led_on(index) led_statue &amp;= 0xFF ^ (1 &lt;&lt; (index) ); write(0, 0, 1, led_statue);</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> led_off(index) led_statue |= 1 &lt;&lt; (index); write(0, 0, 1, led_statue);</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> led_invert(index) led_statue ^= 1 &lt;&lt; (index); write(0, 0, 1, led_statue);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_blank 16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_interval 17 <span class="comment">// 间隔符</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_h 18</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_p 19</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_u 20</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_l 21</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_n 22</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_top 23</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_bottom 24</span></span><br><span class="line"></span><br><span class="line">code u8 nt_code[] = &#123;<span class="number">0xc0</span>,<span class="number">0xf9</span>,<span class="number">0xa4</span>,<span class="number">0xb0</span>,<span class="number">0x99</span>,<span class="number">0x92</span>,<span class="number">0x82</span>,<span class="number">0xf8</span>,<span class="number">0x80</span>,<span class="number">0x90</span>,<span class="number">0x88</span>,<span class="number">0x83</span>,<span class="number">0xc6</span>,<span class="number">0xa1</span>,<span class="number">0x86</span>,<span class="number">0x8e</span>,</span><br><span class="line">						  <span class="number">0xFF</span>, <span class="number">0xBF</span>, <span class="number">0x89</span>, <span class="number">0x8C</span>, <span class="number">0xC1</span>, <span class="number">0xC7</span>, <span class="number">0xC8</span>, <span class="number">0xFE</span>, <span class="number">0xF7</span>&#125;;</span><br><span class="line">u8 nt_buf[<span class="number">8</span>] = &#123;nt_blank, nt_blank, nt_blank, nt_blank, nt_blank, nt_blank, nt_blank, nt_blank&#125;;</span><br><span class="line">u8 nt_index;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_show(pos, dat) write(0, 1, 1, (1 &lt;&lt; (pos))); write(1, 1, 1, (nt_code[(dat)]));</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_showdot(pos, dat) write(0, 1, 1, (1 &lt;&lt; (pos))); write(1, 1, 1, (nt_code[(dat)] &amp; 0x7F));</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">u8 hour, minute, second;</span><br><span class="line"></span><br><span class="line">u16 distance;</span><br><span class="line">u16 distance_max;</span><br><span class="line">u16 distance_min;</span><br><span class="line"><span class="type">float</span> distance_ave;</span><br><span class="line">u8 distance_adjacent_count;</span><br><span class="line">u8 distance_trigger_count;</span><br><span class="line"></span><br><span class="line">u16 param_distance;</span><br><span class="line"></span><br><span class="line">bit capture_mode;		<span class="comment">// 0 -&gt; 触发模式 1-&gt; 定时模式</span></span><br><span class="line">code u8 capture_time[] = &#123;<span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">9</span>&#125;;	<span class="comment">// 用 capture_time[capture_time_index] 而不是 param_time ，节约存储空间（非必要）</span></span><br><span class="line">u8 capture_time_index;	<span class="comment">// 采集时间间隔</span></span><br><span class="line">bit capture_standby;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> light_vol;</span><br><span class="line">bit light_bright;</span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_ms</span><span class="params">(u8 ms)</span> &#123;	<span class="comment">//@12.000MHz</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (ms--) &#123;</span><br><span class="line">		<span class="type">unsigned</span> <span class="type">char</span> data i, j;</span><br><span class="line"></span><br><span class="line">		_nop_();</span><br><span class="line">		_nop_();</span><br><span class="line">		i = <span class="number">12</span>;</span><br><span class="line">		j = <span class="number">168</span>;</span><br><span class="line">		<span class="keyword">do</span> &#123;</span><br><span class="line">			<span class="keyword">while</span> (--j);</span><br><span class="line">		&#125; <span class="keyword">while</span> (--i);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">nt_show_len</span><span class="params">(u8 pos, u32 dat, u8 len)</span> &#123;		<span class="comment">// 固定长度输出，不足补0</span></span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		nt_buf[pos] = dat % <span class="number">10</span>;</span><br><span class="line">		dat /= <span class="number">10</span>;</span><br><span class="line">		pos--;</span><br><span class="line">	&#125; <span class="keyword">while</span> (--len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">nt_show_dot</span><span class="params">(u8 pos, u32 dat, u8 len, u8 dot_pos)</span> &#123;		<span class="comment">// 带小数点输出，不足补0</span></span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (pos == dot_pos) &#123;</span><br><span class="line">			nt_buf[pos] = (dat % <span class="number">10</span>) | <span class="number">0x80</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			nt_buf[pos] = dat % <span class="number">10</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		dat /= <span class="number">10</span>;</span><br><span class="line">		pos--;</span><br><span class="line">	&#125; <span class="keyword">while</span> (--len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">nt_show_blank</span><span class="params">(u8 pos, u32 dat, u8 len)</span> &#123;		<span class="comment">// 固定长度输出，不足补空白</span></span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		nt_buf[pos] = dat % <span class="number">10</span>;</span><br><span class="line">		dat /= <span class="number">10</span>;</span><br><span class="line">		pos--;</span><br><span class="line">	&#125; <span class="keyword">while</span> (--len &amp;&amp; dat);</span><br><span class="line">	<span class="keyword">while</span> (len--) &#123;</span><br><span class="line">		nt_buf[pos] = nt_blank;</span><br><span class="line">		pos--;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">nt_show_dot_blank</span><span class="params">(u8 pos, u32 dat, u8 len, u8 dot_pos)</span> &#123;<span class="comment">// 带小数点输出，不足补空白</span></span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (pos == dot_pos) &#123;</span><br><span class="line">			nt_buf[pos] = (dat % <span class="number">10</span>) | <span class="number">0x80</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			nt_buf[pos] = dat % <span class="number">10</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		dat /= <span class="number">10</span>;</span><br><span class="line">		pos--;</span><br><span class="line">	&#125; <span class="keyword">while</span> (--len &amp;&amp; dat);</span><br><span class="line">	<span class="keyword">while</span> (len--) &#123;</span><br><span class="line">		nt_buf[pos] = nt_blank;</span><br><span class="line">		pos--;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pcf_write</span><span class="params">(u8 ctrl, u8 dat)</span> &#123;</span><br><span class="line">	IIC_Start();</span><br><span class="line">	IIC_SendByte(<span class="number">0x90</span>);	<span class="comment">// 写地址</span></span><br><span class="line">	IIC_WaitAck();</span><br><span class="line">	IIC_SendByte(ctrl);	<span class="comment">// 控制字</span></span><br><span class="line">	IIC_WaitAck();</span><br><span class="line">	IIC_SendByte(dat);	<span class="comment">// D/A数据</span></span><br><span class="line">	IIC_WaitAck();</span><br><span class="line">	IIC_Stop();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> <span class="title function_">pcf_read</span><span class="params">(u8 ctrl)</span> &#123;</span><br><span class="line">	u8 res;</span><br><span class="line">	<span class="comment">// 先写入一次，这是因为pcf8591只会在写入之后做一次A/D转换，直接读取将读到上一次转换之后的值。</span></span><br><span class="line">	IIC_Start();</span><br><span class="line">	IIC_SendByte(<span class="number">0x90</span>);	<span class="comment">// 写地址</span></span><br><span class="line">	IIC_WaitAck();</span><br><span class="line">	IIC_SendByte(ctrl);	<span class="comment">// 这里需要确定一下哪个通道要被读取，AIN1是光敏电阻的传感器</span></span><br><span class="line">	IIC_WaitAck();</span><br><span class="line">	IIC_Stop();</span><br><span class="line">	<span class="comment">// 读取数据</span></span><br><span class="line">	IIC_Start();</span><br><span class="line">	IIC_SendByte(<span class="number">0x91</span>);	<span class="comment">// 读地址</span></span><br><span class="line">	IIC_WaitAck();</span><br><span class="line">	res = IIC_RecByte();<span class="comment">// 读取1byte即可</span></span><br><span class="line">	IIC_SendAck(<span class="number">0</span>);</span><br><span class="line">	IIC_Stop();</span><br><span class="line">	<span class="keyword">return</span> res * <span class="number">5.0f</span> / <span class="number">255.0f</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ds1302_r_reg_hour 0x85</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ds1302_w_reg_hour 0x84</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ds1302_r_reg_minute 0x83</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ds1302_w_reg_minute 0x82</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ds1302_r_reg_second 0x81</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ds1302_w_reg_second 0x80</span></span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="type">float</span> <span class="title function_">temper_read</span><span class="params">()</span> &#123;</span><br><span class="line">	u16 res = <span class="number">0</span>;</span><br><span class="line">	u8 high, low;</span><br><span class="line">	</span><br><span class="line">	init_ds18b20();</span><br><span class="line">	Write_DS18B20(<span class="number">0xCC</span>);</span><br><span class="line">	Write_DS18B20(<span class="number">0x44</span>);</span><br><span class="line">	<span class="comment">// Delay_OneWire(200);</span></span><br><span class="line">	</span><br><span class="line">	init_ds18b20();</span><br><span class="line">	Write_DS18B20(<span class="number">0xCC</span>);</span><br><span class="line">	Write_DS18B20(<span class="number">0xBE</span>);</span><br><span class="line">	<span class="comment">// Delay_OneWire(200);</span></span><br><span class="line">	</span><br><span class="line">	low = Read_DS18B20();</span><br><span class="line">	high = Read_DS18B20();</span><br><span class="line">	</span><br><span class="line">	res = high &amp; <span class="number">0x0F</span>;</span><br><span class="line">	res = (res &lt;&lt; <span class="number">8</span>) | low;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> res * <span class="number">0.0625f</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">e2prom_write</span><span class="params">(u8 addr, u8* dat, u8 len)</span> &#123;</span><br><span class="line">	IIC_Start();</span><br><span class="line">	IIC_SendByte(<span class="number">0xA0</span>);	<span class="comment">// Write Address</span></span><br><span class="line">	IIC_WaitAck();</span><br><span class="line">	IIC_SendByte(addr);</span><br><span class="line">	IIC_WaitAck();</span><br><span class="line">	<span class="keyword">while</span> (len--) &#123;</span><br><span class="line">		IIC_SendByte(dat[len]);</span><br><span class="line">		IIC_WaitAck();</span><br><span class="line">	&#125;</span><br><span class="line">	IIC_Stop();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">e2prom_read</span><span class="params">(u8 addr, u8* dat, u8 len)</span> &#123;</span><br><span class="line">	u8 i;</span><br><span class="line">	IIC_Start();</span><br><span class="line">	IIC_SendByte(<span class="number">0xA0</span>);	<span class="comment">// Write Address</span></span><br><span class="line">	IIC_WaitAck();</span><br><span class="line">	IIC_SendByte(addr);</span><br><span class="line">	IIC_WaitAck();</span><br><span class="line">	</span><br><span class="line">	IIC_Start();	<span class="comment">// Restart</span></span><br><span class="line">	IIC_SendByte(<span class="number">0xA1</span>);	<span class="comment">// Read Address</span></span><br><span class="line">	IIC_WaitAck();</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; ++i) &#123;</span><br><span class="line">		dat[i] = IIC_RecByte();</span><br><span class="line">		IIC_SendAck(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">sbit TX = P1^<span class="number">0</span>;</span><br><span class="line">sbit RX = P1^<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sonic_send_signal</span><span class="params">()</span> &#123;</span><br><span class="line">	u8 i;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; ++i) &#123;</span><br><span class="line">		TX = <span class="number">1</span>;</span><br><span class="line">		_nop_();_nop_();_nop_();_nop_();_nop_();_nop_();_nop_();_nop_(); <span class="comment">// 8个 _nop_();</span></span><br><span class="line">		TX = <span class="number">0</span>;</span><br><span class="line">		_nop_();_nop_();_nop_();_nop_();_nop_();_nop_();_nop_();_nop_();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">u16 <span class="title function_">sonic_get_dist</span><span class="params">()</span> &#123;</span><br><span class="line">	u16 tim;			<span class="comment">// 计数时间</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// AUXR &amp;= 0xFB;</span></span><br><span class="line">	TMOD &amp;= <span class="number">0xF0</span>;</span><br><span class="line">	TF0 = <span class="number">0</span>;</span><br><span class="line">	TH0 = <span class="number">0x00</span>;				<span class="comment">// 计数器初始化</span></span><br><span class="line">	TL0 = <span class="number">0x00</span>;</span><br><span class="line">	sonic_send_signal();</span><br><span class="line">	TR0 = <span class="number">1</span>;				<span class="comment">// 开始计数</span></span><br><span class="line">	<span class="keyword">while</span> ( (RX == <span class="number">1</span>) &amp;&amp; (TF0 == <span class="number">0</span>) ); 	<span class="comment">// 接收到信号时，RX == 1；如果计数器溢出（TF==1）则结束计时。</span></span><br><span class="line">	TR0 = <span class="number">0</span>;				<span class="comment">// 计数结束</span></span><br><span class="line">	<span class="comment">// 当正常接收到信号时</span></span><br><span class="line">	<span class="keyword">if</span> (TF0 == <span class="number">0</span>) &#123;</span><br><span class="line">		tim = TH0;</span><br><span class="line">		tim = (tim &lt;&lt; <span class="number">8</span>) | TL0;</span><br><span class="line">		<span class="keyword">return</span> (u16)(tim * <span class="number">0.017</span>);		<span class="comment">// distance = 0.000001s * 34000 cm/s /  2 = 0.017 cm/s</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 若溢出，中断标志清零，并返回0</span></span><br><span class="line">	TF0 = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// #define use_infrared</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> use_infrared</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// use_infrared</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">u8 <span class="title function_">keys_scan</span><span class="params">()</span> &#123;</span><br><span class="line">	u8 temp = <span class="number">0x00</span>;</span><br><span class="line">	P3 = <span class="number">0x30</span>; P42 = <span class="number">1</span>; P44 = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span> (P3 != <span class="number">0x0C</span> || P42 != <span class="number">0</span> || P44 != <span class="number">0</span>) &#123;</span><br><span class="line">		temp = P3 | (u8)P42 &lt;&lt; <span class="number">6</span> | (u8)P44 &lt;&lt; <span class="number">7</span>;</span><br><span class="line">		<span class="comment">// delay_ms(10);</span></span><br><span class="line">		P3 = <span class="number">0x0F</span>; P42 = <span class="number">0</span>; P44 = <span class="number">0</span>;</span><br><span class="line">		temp |= P3;</span><br><span class="line">		<span class="keyword">switch</span> (temp) &#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0x7E</span>: <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xBE</span>: <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xDE</span>: <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xEE</span>: <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0x7D</span>: <span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xBD</span>: <span class="keyword">return</span> <span class="number">6</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xDD</span>: <span class="keyword">return</span> <span class="number">7</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xED</span>: <span class="keyword">return</span> <span class="number">8</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0x7B</span>: <span class="keyword">return</span> <span class="number">9</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xBB</span>: <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xDB</span>: <span class="keyword">return</span> <span class="number">11</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xEB</span>: <span class="keyword">return</span> <span class="number">12</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0x77</span>: <span class="keyword">return</span> <span class="number">13</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xB7</span>: <span class="keyword">return</span> <span class="number">14</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xD7</span>: <span class="keyword">return</span> <span class="number">15</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xE7</span>: <span class="keyword">return</span> <span class="number">16</span>;</span><br><span class="line">			<span class="keyword">default</span>: <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">timer0_Init</span><span class="params">(<span class="type">void</span>)</span>		<span class="comment">//1000微秒12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">	AUXR |= <span class="number">0x80</span>;			<span class="comment">//定时器时钟1T模式</span></span><br><span class="line">	TMOD &amp;= <span class="number">0xF0</span>;			<span class="comment">//设置定时器模式</span></span><br><span class="line">	TMOD |= <span class="number">0x04</span>;</span><br><span class="line">	TL0 = <span class="number">0xFF</span>;				<span class="comment">//设置定时初值</span></span><br><span class="line">	TH0 = <span class="number">0xFF</span>;				<span class="comment">//设置定时初值</span></span><br><span class="line">	TF0 = <span class="number">0</span>;				<span class="comment">//清除TF0标志</span></span><br><span class="line">	<span class="comment">// TR0 = 1;				//定时器0开始计时</span></span><br><span class="line">	<span class="comment">// ET0 = 1;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">timer1_Init</span><span class="params">(<span class="type">void</span>)</span>		<span class="comment">//1000微秒12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">	AUXR |= <span class="number">0x40</span>;			<span class="comment">//定时器时钟1T模式</span></span><br><span class="line">	TMOD &amp;= <span class="number">0x0F</span>;			<span class="comment">//设置定时器模式</span></span><br><span class="line">	TL1 = <span class="number">0x20</span>;				<span class="comment">//设置定时初始值</span></span><br><span class="line">	TH1 = <span class="number">0xD1</span>;				<span class="comment">//设置定时初始值</span></span><br><span class="line">	TF1 = <span class="number">0</span>;				<span class="comment">//清除TF1标志</span></span><br><span class="line">	TR1 = <span class="number">1</span>;				<span class="comment">//定时器1开始计时</span></span><br><span class="line">	ET1 = <span class="number">1</span>;				<span class="comment">//使能定时器1中断</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">u8 interface, interface_data, interface_data_record, interface_param;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_time</span><span class="params">(<span class="type">void</span>)</span> &#123;				<span class="comment">// 时间显示</span></span><br><span class="line">	nt_show_len(<span class="number">1</span>, hour, <span class="number">2</span>);</span><br><span class="line">	nt_buf[<span class="number">2</span>] = nt_interval;</span><br><span class="line">	nt_show_len(<span class="number">4</span>, minute, <span class="number">2</span>);</span><br><span class="line">	nt_buf[<span class="number">5</span>] = nt_interval;</span><br><span class="line">	nt_show_len(<span class="number">7</span>, second, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_distance</span><span class="params">(<span class="type">void</span>)</span> &#123;			<span class="comment">// 距离显示</span></span><br><span class="line">	nt_buf[<span class="number">0</span>] = nt_l;</span><br><span class="line">	<span class="keyword">if</span> (capture_mode == <span class="number">0</span>) &#123;	<span class="comment">// 触发模式</span></span><br><span class="line">		nt_buf[<span class="number">1</span>] = <span class="number">0x0C</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;		<span class="comment">// 定时模式</span></span><br><span class="line">		nt_buf[<span class="number">1</span>] = <span class="number">0x0F</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 偷懒，比赛的时候肯定会手写nt_buf[...] = nt_blank</span></span><br><span class="line">	nt_show_blank(<span class="number">7</span>, distance, <span class="number">6</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_dat_max</span><span class="params">(<span class="type">void</span>)</span> &#123;			<span class="comment">// </span></span><br><span class="line">	nt_buf[<span class="number">0</span>] = nt_h;</span><br><span class="line">	nt_buf[<span class="number">1</span>] = nt_top;</span><br><span class="line">	<span class="comment">// 偷懒</span></span><br><span class="line">	nt_show_blank(<span class="number">7</span>, distance_max, <span class="number">6</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_dat_ave</span><span class="params">(<span class="type">void</span>)</span> &#123;			<span class="comment">// </span></span><br><span class="line">	nt_buf[<span class="number">0</span>] = nt_h;</span><br><span class="line">	nt_buf[<span class="number">1</span>] = nt_interval;</span><br><span class="line">	nt_show_dot_blank(<span class="number">7</span>, distance_ave * <span class="number">10</span>, <span class="number">5</span>, <span class="number">6</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_dat_min</span><span class="params">(<span class="type">void</span>)</span> &#123;			<span class="comment">// </span></span><br><span class="line">	nt_buf[<span class="number">0</span>] = nt_h;</span><br><span class="line">	nt_buf[<span class="number">1</span>] = nt_bottom;</span><br><span class="line">	<span class="comment">// 偷懒</span></span><br><span class="line">	nt_show_blank(<span class="number">7</span>, distance_min, <span class="number">6</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_param_time</span><span class="params">(<span class="type">void</span>)</span> &#123;		<span class="comment">// 采集时间参数</span></span><br><span class="line">	nt_buf[<span class="number">0</span>] = nt_p;</span><br><span class="line">	nt_buf[<span class="number">1</span>] = <span class="number">0x01</span>;</span><br><span class="line">	nt_buf[<span class="number">2</span>] = nt_buf[<span class="number">3</span>] = nt_buf[<span class="number">4</span>] = nt_buf[<span class="number">5</span>] = nt_blank;</span><br><span class="line">	nt_show_len(<span class="number">7</span>, capture_time[capture_time_index], <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_param_distance</span><span class="params">(<span class="type">void</span>)</span> &#123;	<span class="comment">// 距离参数</span></span><br><span class="line">	nt_buf[<span class="number">0</span>] = nt_p;</span><br><span class="line">	nt_buf[<span class="number">1</span>] = <span class="number">0x02</span>;</span><br><span class="line">	nt_buf[<span class="number">2</span>] = nt_buf[<span class="number">3</span>] = nt_buf[<span class="number">4</span>] = nt_buf[<span class="number">5</span>] = nt_blank;</span><br><span class="line">	nt_show_len(<span class="number">7</span>, param_distance, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="keyword">switch</span> (interface) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">			<span class="keyword">switch</span> (interface_data) &#123;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">					draw_time();</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">					draw_distance();</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">					<span class="keyword">switch</span> (interface_data_record) &#123;</span><br><span class="line">						<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">							draw_dat_max();</span><br><span class="line">							<span class="keyword">break</span>;</span><br><span class="line">						<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">							draw_dat_min();</span><br><span class="line">							<span class="keyword">break</span>;</span><br><span class="line">						<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">							draw_dat_ave();</span><br><span class="line">							<span class="keyword">break</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">			<span class="keyword">switch</span> (interface_param) &#123;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">					draw_param_time();</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">					draw_param_distance();</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// led</span></span><br><span class="line">	<span class="keyword">if</span> (interface == <span class="number">0</span> &amp;&amp; interface_data == <span class="number">0</span>) &#123;</span><br><span class="line">		led_on(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		led_off(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (interface == <span class="number">0</span> &amp;&amp; interface_data == <span class="number">1</span>) &#123;</span><br><span class="line">		led_on(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		led_off(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (interface == <span class="number">0</span> &amp;&amp; interface_data == <span class="number">2</span>) &#123;</span><br><span class="line">		led_on(<span class="number">2</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		led_off(<span class="number">2</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (capture_mode == <span class="number">0</span>) &#123;</span><br><span class="line">		led_on(<span class="number">3</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		led_off(<span class="number">3</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (distance_adjacent_count &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">		led_on(<span class="number">4</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		led_off(<span class="number">4</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (light_vol &gt; <span class="number">3.0f</span>) &#123;</span><br><span class="line">		led_on(<span class="number">5</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		led_off(<span class="number">5</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">key_event</span><span class="params">(u8 key)</span> &#123;</span><br><span class="line">	<span class="type">static</span> bit press_flag = <span class="number">0</span>;			<span class="comment">// 用于判断按键是不是刚刚按下——实现一些按键的下降沿触发</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (timer_key &lt; <span class="number">50</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	timer_key = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">switch</span> (key) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">13</span>:	<span class="comment">// S4</span></span><br><span class="line">			<span class="keyword">if</span> (press_flag)	<span class="comment">// 只能是按下的时刻被触发，不能是</span></span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			press_flag = <span class="number">1</span>;	<span class="comment">// 实话说，这种写法是感觉告诉我的，，，一坨史，，，它将在default中被置为0，，，感觉是朴素的小学数学思想所致</span></span><br><span class="line"></span><br><span class="line">			++interface;</span><br><span class="line">			interface %= <span class="number">2</span>;</span><br><span class="line">			interface_data = <span class="number">0</span>;		<span class="comment">// 别忘了这个！！！</span></span><br><span class="line">			interface_param = <span class="number">0</span>;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">			</span><br><span class="line">		<span class="keyword">case</span> <span class="number">9</span>:	<span class="comment">// S5</span></span><br><span class="line">			<span class="keyword">if</span> (press_flag)	<span class="comment">// 只能是按下的时刻被触发，不能是</span></span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			press_flag = <span class="number">1</span>;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span> (interface == <span class="number">0</span>) &#123;</span><br><span class="line">				interface_data++;</span><br><span class="line">				interface_data %= <span class="number">3</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (interface == <span class="number">1</span>) &#123;</span><br><span class="line">				interface_param++;</span><br><span class="line">				interface_param %= <span class="number">2</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">14</span>:	<span class="comment">// S8</span></span><br><span class="line">			<span class="keyword">if</span> (press_flag)	<span class="comment">// 只能是按下的时刻被触发，不能是</span></span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			press_flag = <span class="number">1</span>;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span> (interface == <span class="number">0</span> &amp;&amp; interface_data == <span class="number">1</span>) &#123;	<span class="comment">// 参数界面下按下S8</span></span><br><span class="line">				capture_mode = !capture_mode;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (interface == <span class="number">0</span> &amp;&amp; interface_data == <span class="number">2</span>) &#123;</span><br><span class="line">				interface_data_record++;</span><br><span class="line">				interface_data_record %= <span class="number">3</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">			</span><br><span class="line">		<span class="keyword">case</span> <span class="number">10</span>:	<span class="comment">// S9</span></span><br><span class="line">			<span class="keyword">if</span> (press_flag)	<span class="comment">// 只能是按下的时刻被触发，不能是</span></span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			press_flag = <span class="number">1</span>;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span> (interface == <span class="number">1</span>) &#123;</span><br><span class="line">				<span class="keyword">if</span> (interface_param == <span class="number">0</span>) &#123;</span><br><span class="line">					capture_time_index++;</span><br><span class="line">					capture_time_index %= <span class="number">5</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span> (interface_param == <span class="number">1</span>) &#123;</span><br><span class="line">					param_distance += <span class="number">10</span>;</span><br><span class="line">					<span class="keyword">if</span> (param_distance &gt; <span class="number">80</span>) &#123;</span><br><span class="line">						param_distance = <span class="number">10</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			press_flag = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">distance_capture</span><span class="params">()</span> &#123;		<span class="comment">// 距离信息捕获</span></span><br><span class="line">	i16 distance_subtract;</span><br><span class="line">	</span><br><span class="line">	distance = sonic_get_dist();</span><br><span class="line">	</span><br><span class="line">	distance_subtract = (i16)distance - (i16)param_distance;</span><br><span class="line">	<span class="keyword">if</span> (distance_subtract &gt;= <span class="number">-5</span> &amp;&amp; distance_subtract &lt;= <span class="number">5</span>) &#123;</span><br><span class="line">		distance_adjacent_count++;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		distance_adjacent_count = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (distance &gt; distance_max) &#123;</span><br><span class="line">		distance_max = distance;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (distance &lt; distance_min) &#123;</span><br><span class="line">		distance_min = distance;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	distance_ave = (distance_ave * distance_trigger_count + distance * <span class="number">1.0f</span>) / (distance_trigger_count + <span class="number">1.0f</span>);</span><br><span class="line">	</span><br><span class="line">	distance_trigger_count++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">update</span><span class="params">()</span> &#123;</span><br><span class="line">	u8 dat;</span><br><span class="line">	</span><br><span class="line">	dat = Read_Ds1302_Byte(ds1302_r_reg_hour) &amp; <span class="number">0x3F</span>;</span><br><span class="line">	hour = (dat &gt;&gt; <span class="number">4</span>) * <span class="number">10</span> + (dat &amp; <span class="number">0x0F</span>);</span><br><span class="line">	dat = Read_Ds1302_Byte(ds1302_r_reg_minute) &amp; <span class="number">0x7F</span>;</span><br><span class="line">	minute = (dat &gt;&gt; <span class="number">4</span>) * <span class="number">10</span> + (dat &amp; <span class="number">0x0F</span>);</span><br><span class="line">	dat = Read_Ds1302_Byte(ds1302_r_reg_second) &amp; <span class="number">0x7F</span>;</span><br><span class="line">	second = (dat &gt;&gt; <span class="number">4</span>) * <span class="number">10</span> + (dat &amp; <span class="number">0x0F</span>);</span><br><span class="line">	</span><br><span class="line">	light_vol = pcf_read(<span class="number">0x41</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (light_vol &gt; <span class="number">3.0f</span>) &#123;</span><br><span class="line">		light_bright = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (light_vol &lt; <span class="number">2.4f</span> &amp;&amp; light_bright &amp;&amp; capture_mode == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">// 触发模式采集</span></span><br><span class="line">		distance_capture();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (light_vol &lt; <span class="number">2.4f</span>) &#123;</span><br><span class="line">		light_bright = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (distance &lt;= <span class="number">10</span>) &#123;</span><br><span class="line">		pcf_write(<span class="number">0x41</span>, <span class="number">51</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (distance &gt;= <span class="number">80</span>) &#123;</span><br><span class="line">		pcf_write(<span class="number">0x41</span>, <span class="number">255</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		pcf_write(<span class="number">0x41</span>, (<span class="number">0.0571</span> * (distance - <span class="number">10.0f</span>) + <span class="number">1.0f</span>) / <span class="number">5.0f</span> * <span class="number">256.0f</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (capture_mode == <span class="number">1</span>)&#123;</span><br><span class="line">		<span class="comment">// 定时模式采集</span></span><br><span class="line">		<span class="keyword">if</span> (second % capture_time[capture_time_index] == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (capture_standby == <span class="number">0</span>) &#123;</span><br><span class="line">				distance_capture();</span><br><span class="line">				capture_standby = <span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			capture_standby = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	write(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0xFF</span>);</span><br><span class="line">	write(<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0x00</span>);</span><br><span class="line">	write(<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0x00</span>);</span><br><span class="line">	write(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0xFF</span>);</span><br><span class="line"></span><br><span class="line">	init_ds18b20();</span><br><span class="line">	</span><br><span class="line">	pcf_write(<span class="number">0x43</span>, <span class="number">51</span>);</span><br><span class="line">	</span><br><span class="line">	timer1_Init();</span><br><span class="line">	</span><br><span class="line">	Write_Ds1302_Byte(ds1302_w_reg_hour, <span class="number">0x16</span>);</span><br><span class="line">	Write_Ds1302_Byte(ds1302_w_reg_minute, <span class="number">0x59</span>);</span><br><span class="line">	Write_Ds1302_Byte(ds1302_w_reg_second, <span class="number">0x50</span>);</span><br><span class="line">	</span><br><span class="line">	EA = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	init();</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		draw();</span><br><span class="line">		update();</span><br><span class="line">		key_event(keys_scan());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">timer0_int</span><span class="params">(<span class="type">void</span>)</span> interrupt 1 &#123;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">timer1_int</span><span class="params">(<span class="type">void</span>)</span> interrupt 3 &#123;</span><br><span class="line">	nt_index %= <span class="number">8</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (nt_buf[nt_index] &amp; <span class="number">0x80</span>) &#123; <span class="comment">// 小数点注记方法：第八位置1</span></span><br><span class="line">		nt_showdot(nt_index, nt_buf[nt_index] &amp; <span class="number">0x7F</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		nt_show(nt_index, nt_buf[nt_index]);</span><br><span class="line">	&#125;</span><br><span class="line">	nt_index++;</span><br><span class="line">	timer_key++;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="TH13"><a href="#TH13" class="headerlink" title="TH13"></a>TH13</h2><p>很罕见的，跳线J5需要设置为BTN独立按键模式。<br>这说明了，<code>竞赛板配置要求</code>还是需要读一读的。</p>
<p>很吓人的是，当我读到“N_MOTOR(J3-6)”时，我<em>看走眼了</em>，我屋以为是让我将那个锁存器上的3-6号引脚都输出80%占比的PWM波……这还是在我知道如何用PWM调节电机速度的前提下。</p>
<h3 id="代码特点"><a href="#代码特点" class="headerlink" title="代码特点"></a>代码特点</h3><p>时隔多日（再次点开这些东西已经是5月下旬了）没写，我直接从新建工程开始重新码了一遍框架和代码。新的代码里面包含了比较成熟的超声波测距代码，这个测距代码不需要我们占用timer0的资源，从而将timer0与超声波测距任务解耦，可以专门服务于频率测量。</p>
<p>这里破天荒地将timer1的周期改成了50us，并且加了个<code>timer1_50us_counter</code>来保证原来那些<code>1ms</code>为周期的任务仍然能保持<code>1ms</code>的周期。</p>
<p>未测试的代码：红外线（没有相关设备）、串口（与频率测量任务冲突，懒得去测了，回头做TH10的时候再弄）</p>
<article class="message is-warning">
        <div class="message-header"><p>注意！</p>
</div>
        <div class="message-body">
            <p>这个代码里的继电器有错误，可以调用的继电器请看<a href="#th14">TH14代码中的Update</a></p>

        </div>
    </article>
<h3 id="代码-2"><a href="#代码-2" class="headerlink" title="代码"></a>代码</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2024年5月23日重写全部，包括基本代码在内</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stc15.h&quot;</span>			<span class="comment">// 从stc-isp软件中获取stc15.h，不使用reg51.h</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ds1302.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;iic.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;onewire.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;intrins.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">char</span> i8;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> u8;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">int</span> i16;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> u16;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> i32;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> u32;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> attach(x, y, z) P25 = (x); P26 = (y); P27 = (z);</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> detach() P27 = 0; P25 = 0; P26 = 0;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> write_0xff(x, y, z, value) P0 = 0xFF; attach(x, y, z); P0 = (value); detach();</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> write_0x00(x, y, z, value) P0 = 0x00; attach(x, y, z); P0 = (value); detach();</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************************/</span></span><br><span class="line"></span><br><span class="line">u8 led_statue;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> led_on(index) led_statue &amp;= 0xFF ^ (1 &lt;&lt; (index)); write_0xff(0, 0, 1, (led_statue));</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> led_off(index) led_statue |= 1 &lt;&lt; (index); write_0xff(0, 0, 1, (led_statue));</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> led_inv(index) led_statue ^= 1 &lt;&lt; (index); write_0xff(0, 0, 1, (led_statue));</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_blank 16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_interval 17 <span class="comment">// 间隔符（中间横杠）</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_h 18</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_p 19</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_u 20</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_l 21</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_n 22</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_top 23		<span class="comment">// 顶部横杠</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_bottom 24	<span class="comment">// 底部横杠</span></span></span><br><span class="line"></span><br><span class="line">code u8 nt_code[] = &#123;<span class="number">0xc0</span>,<span class="number">0xf9</span>,<span class="number">0xa4</span>,<span class="number">0xb0</span>,<span class="number">0x99</span>,<span class="number">0x92</span>,<span class="number">0x82</span>,<span class="number">0xf8</span>,<span class="number">0x80</span>,<span class="number">0x90</span>,<span class="number">0x88</span>,<span class="number">0x83</span>,<span class="number">0xc6</span>,<span class="number">0xa1</span>,<span class="number">0x86</span>,<span class="number">0x8e</span>,</span><br><span class="line">						  <span class="number">0xFF</span>, <span class="number">0xBF</span>, <span class="number">0x89</span>, <span class="number">0x8C</span>, <span class="number">0xC1</span>, <span class="number">0xC7</span>, <span class="number">0xC8</span>, <span class="number">0xFE</span>, <span class="number">0xF7</span>&#125;;</span><br><span class="line">u8 nt_buf[<span class="number">8</span>] = &#123;nt_blank, nt_blank, nt_blank, nt_blank, nt_blank, nt_blank, nt_blank, nt_blank&#125;;</span><br><span class="line">u8 nt_index;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_show(pos, index) write_0x00(0, 1, 1, (1 &lt;&lt; (pos))); write_0xff(1, 1, 1, (nt_code[(index)]));</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_show_dot(pos, index) write_0x00(0, 1, 1, (1 &lt;&lt; (pos)));  write_0xff(1, 1, 1, (nt_code[(index)] &amp; 0x7F));</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_ms</span><span class="params">(u8 ms)</span> &#123;	<span class="comment">//@12.000MHz</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (ms--) &#123;</span><br><span class="line">		<span class="type">unsigned</span> <span class="type">char</span> data i, j;</span><br><span class="line"></span><br><span class="line">		_nop_();</span><br><span class="line">		_nop_();</span><br><span class="line">		i = <span class="number">12</span>;</span><br><span class="line">		j = <span class="number">168</span>;</span><br><span class="line">		<span class="keyword">do</span> &#123;</span><br><span class="line">			<span class="keyword">while</span> (--j);</span><br><span class="line">		&#125; <span class="keyword">while</span> (--i);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_100us</span><span class="params">(<span class="type">void</span>)</span> &#123;	<span class="comment">//@12.000MHz</span></span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> data i, j;</span><br><span class="line"></span><br><span class="line">	i = <span class="number">2</span>;</span><br><span class="line">	j = <span class="number">39</span>;</span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">while</span> (--j);</span><br><span class="line">	&#125; <span class="keyword">while</span> (--i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************************/</span></span><br><span class="line"></span><br><span class="line">u16 timer_key;	<span class="comment">// 在key_event里用于实现消抖、按键释放后再去触发等机制</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 这个框架里给出了独立按键的处理代码。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 扫描按键，注意这里return的与开发板上的按键下标不同。</span></span><br><span class="line"><span class="comment">// 这里采用了最方便用switch写代码的方法去写。</span></span><br><span class="line">u8 <span class="title function_">keys_scan</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	u8 temp = <span class="number">0x00</span>;</span><br><span class="line">	P3 = <span class="number">0x30</span>; P52 = <span class="number">1</span>; P44 = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span> (P3 != <span class="number">0x0C</span> || P42 != <span class="number">0</span> || P44 != <span class="number">0</span>) &#123;</span><br><span class="line">		temp = P3 | (u8)P42 &lt;&lt; <span class="number">6</span> || (u8)P44 &lt;&lt; <span class="number">7</span>;</span><br><span class="line">		<span class="comment">// 可以不考虑在这里消抖，因为我们的key_event()函数里面有。</span></span><br><span class="line">		<span class="comment">// 但是需要delay一个比较短的时间，这是考虑了分布电容</span></span><br><span class="line">		delay_100us();</span><br><span class="line">		P3 = <span class="number">0x0F</span>; P42 = <span class="number">0</span>; P44 = <span class="number">0</span>;</span><br><span class="line">		delay_100us();</span><br><span class="line">		temp |= P3;</span><br><span class="line">		<span class="keyword">switch</span> (temp) &#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0x7E</span>: <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xBE</span>: <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xDE</span>: <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xEE</span>: <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0x7D</span>: <span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xBD</span>: <span class="keyword">return</span> <span class="number">6</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xDD</span>: <span class="keyword">return</span> <span class="number">7</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xED</span>: <span class="keyword">return</span> <span class="number">8</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0x7B</span>: <span class="keyword">return</span> <span class="number">9</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xBB</span>: <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xDB</span>: <span class="keyword">return</span> <span class="number">11</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xEB</span>: <span class="keyword">return</span> <span class="number">12</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0x77</span>: <span class="keyword">return</span> <span class="number">13</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xB7</span>: <span class="keyword">return</span> <span class="number">14</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xD7</span>: <span class="keyword">return</span> <span class="number">15</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xE7</span>: <span class="keyword">return</span> <span class="number">16</span>;</span><br><span class="line">			<span class="keyword">default</span>: <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 独立按键模式</span></span><br><span class="line"><span class="comment">// 4个引脚分别检测，不用switch</span></span><br><span class="line">u8 <span class="title function_">keys_btn</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	P30 = <span class="number">1</span>;</span><br><span class="line">	delay_100us();</span><br><span class="line">	<span class="keyword">if</span> (P30 == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	P31 = <span class="number">1</span>;</span><br><span class="line">	delay_100us();</span><br><span class="line">	<span class="keyword">if</span> (P31 == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	P32 = <span class="number">1</span>;</span><br><span class="line">	delay_100us();</span><br><span class="line">	<span class="keyword">if</span> (P32 == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">9</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	P33 = <span class="number">1</span>;</span><br><span class="line">	delay_100us();</span><br><span class="line">	<span class="keyword">if</span> (P33 == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">13</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 补0</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">nt_buf_show_len</span><span class="params">(u8 pos, u32 dat, u8 len)</span> &#123;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		nt_buf[pos] = dat % <span class="number">10</span>;</span><br><span class="line">		dat /= <span class="number">10</span>;</span><br><span class="line">		pos--;</span><br><span class="line">	&#125; <span class="keyword">while</span>(--len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 补空白</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">nt_buf_show_blank</span><span class="params">(u8 pos, u32 dat, u8 len)</span> &#123;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		nt_buf[pos] = dat % <span class="number">10</span>;</span><br><span class="line">		dat /= <span class="number">10</span>;</span><br><span class="line">		pos--;</span><br><span class="line">	&#125; <span class="keyword">while</span>(--len &amp;&amp; dat);</span><br><span class="line">	<span class="keyword">while</span> (len--) &#123;</span><br><span class="line">		nt_buf[pos] = nt_blank;</span><br><span class="line">		pos--;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 带小数点，补0</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">nt_buf_show_dot</span><span class="params">(u8 pos, u32 dat, u8 len, u8 pos_dot)</span> &#123;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (pos == pos_dot) &#123;</span><br><span class="line">			nt_buf[pos] = (dat % <span class="number">10</span>) | <span class="number">0x80</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			nt_buf[pos] = dat % <span class="number">10</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		dat /= <span class="number">10</span>;</span><br><span class="line">		pos--;</span><br><span class="line">	&#125; <span class="keyword">while</span> (--len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 带小数点，补空白</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">nt_buf_show_dot_blank</span><span class="params">(u8 pos, u32 dat, u8 len, u8 pos_dot)</span> &#123;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (pos == pos_dot) &#123;</span><br><span class="line">			nt_buf[pos] = (dat % <span class="number">10</span>) | <span class="number">0x80</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			nt_buf[pos] = dat % <span class="number">10</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		dat /= <span class="number">10</span>;</span><br><span class="line">		pos--;</span><br><span class="line">	&#125; <span class="keyword">while</span> (--len &amp;&amp; dat);</span><br><span class="line">	<span class="keyword">while</span> (len--) &#123;</span><br><span class="line">		nt_buf[pos] = nt_blank;</span><br><span class="line">		pos--;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pcf_write</span><span class="params">(u8 ctrl, u8 dat)</span> &#123;</span><br><span class="line">	I2CStart();</span><br><span class="line">	I2CSendByte(<span class="number">0x90</span>);</span><br><span class="line">	I2CWaitAck();</span><br><span class="line">	I2CSendByte(ctrl);</span><br><span class="line">	I2CWaitAck();</span><br><span class="line">	I2CSendByte(dat);</span><br><span class="line">	I2CWaitAck();</span><br><span class="line">	I2CStop();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> <span class="title function_">pcf_read</span><span class="params">(u8 ctrl)</span> &#123;</span><br><span class="line">	u8 res;</span><br><span class="line">	I2CStart();</span><br><span class="line">	I2CSendByte(<span class="number">0x90</span>);</span><br><span class="line">	I2CWaitAck();</span><br><span class="line">	I2CSendByte(ctrl);</span><br><span class="line">	I2CWaitAck();</span><br><span class="line">	I2CStop();</span><br><span class="line">	</span><br><span class="line">	I2CStart();</span><br><span class="line">	I2CSendByte(<span class="number">0x91</span>);</span><br><span class="line">	I2CWaitAck();</span><br><span class="line">	res = I2CReceiveByte();</span><br><span class="line">	I2CSendAck(<span class="number">0</span>);</span><br><span class="line">	I2CStop();</span><br><span class="line">	<span class="keyword">return</span> res * <span class="number">5.0f</span> / <span class="number">255.0f</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ds1302_r_reg_hour 0x85</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ds1302_w_reg_hour 0x84</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ds1302_r_reg_minute 0x83</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ds1302_w_reg_minute 0x82</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ds1302_r_reg_second 0x81</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ds1302_w_reg_second 0x80</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="type">float</span> <span class="title function_">temper_read</span><span class="params">()</span> &#123;</span><br><span class="line">	u16 res = <span class="number">0</span>;</span><br><span class="line">	u8 high, low;</span><br><span class="line">	init_ds18b20();</span><br><span class="line">	Write_DS18B20(<span class="number">0xCC</span>);</span><br><span class="line">	Write_DS18B20(<span class="number">0x44</span>);</span><br><span class="line">	</span><br><span class="line">	init_ds18b20();</span><br><span class="line">	Write_DS18B20(<span class="number">0xCC</span>);</span><br><span class="line">	Write_DS18B20(<span class="number">0xBE</span>);</span><br><span class="line">	</span><br><span class="line">	low = Read_DS18B20();</span><br><span class="line">	high = Read_DS18B20();</span><br><span class="line">	res = high &amp; <span class="number">0x0F</span>;</span><br><span class="line">	res = (res &lt;&lt; <span class="number">8</span>) | low;</span><br><span class="line">	<span class="keyword">return</span> res * <span class="number">0.0625f</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">e2prom_set_addr</span><span class="params">(u8 addr)</span> &#123;</span><br><span class="line">	I2CStart();</span><br><span class="line">	I2CSendByte(<span class="number">0xA0</span>);</span><br><span class="line">	I2CWaitAck();</span><br><span class="line">	I2CSendByte(addr);</span><br><span class="line">	I2CWaitAck();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">e2prom_write</span><span class="params">(u8 *dat, u8 len)</span> &#123;</span><br><span class="line">	u8 i;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; ++i) &#123;</span><br><span class="line">		I2CSendByte(dat[i]);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 多数题目都只是要求我们去读写一字节的东西，所以这里就只写一个单字节读取了。</span></span><br><span class="line"><span class="comment">// 想要扩展成多字节读取，可以参考e2prom_write();</span></span><br><span class="line">u8 <span class="title function_">e2prom_read</span><span class="params">()</span> &#123;</span><br><span class="line">	u8 tmp;</span><br><span class="line">	I2CStart();</span><br><span class="line">	I2CSendByte(<span class="number">0xA1</span>);</span><br><span class="line">	I2CWaitAck();</span><br><span class="line">	tmp = I2CReceiveByte();</span><br><span class="line">	I2CSendAck(<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">return</span> tmp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 串口通信</span></span><br><span class="line"><span class="comment">// #define use_uart</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> use_uart</span></span><br><span class="line"></span><br><span class="line">u8 uart_dat;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">uart_init</span><span class="params">(<span class="type">void</span>)</span>	<span class="comment">//9600bps@12.000MHz UART1</span></span><br><span class="line">&#123;</span><br><span class="line">	SCON = <span class="number">0x50</span>;		<span class="comment">//8位数据,可变波特率</span></span><br><span class="line">	AUXR |= <span class="number">0x40</span>;		<span class="comment">//定时器时钟1T模式</span></span><br><span class="line">	AUXR &amp;= <span class="number">0xFE</span>;		<span class="comment">//串口1选择定时器1为波特率发生器</span></span><br><span class="line">	TMOD &amp;= <span class="number">0x0F</span>;		<span class="comment">//设置定时器模式</span></span><br><span class="line">	TL1 = <span class="number">0xC7</span>;			<span class="comment">//设置定时初始值</span></span><br><span class="line">	TH1 = <span class="number">0xFE</span>;			<span class="comment">//设置定时初始值</span></span><br><span class="line">	ET1 = <span class="number">0</span>;			<span class="comment">//禁止定时器中断</span></span><br><span class="line">	TR1 = <span class="number">1</span>;			<span class="comment">//定时器1开始计时</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">uart_send_byte</span><span class="params">(u8 dat)</span> &#123;</span><br><span class="line">	SBUF = dat;</span><br><span class="line">	<span class="keyword">while</span> (TI == <span class="number">0</span>);</span><br><span class="line">	TI = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">uart_int</span><span class="params">(<span class="type">void</span>)</span> interrupt 4 &#123;</span><br><span class="line">	<span class="keyword">if</span> (RI == <span class="number">1</span>) &#123;</span><br><span class="line">		uart_dat = SBUF;</span><br><span class="line">		RI = <span class="number">0</span>;</span><br><span class="line">		<span class="comment">// do sth else...</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// use_uart</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 超声波和红外线互斥，所以要用个define来实现选用</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> use_sonic	<span class="comment">// 使用超声波</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> use_sonic</span></span><br><span class="line"></span><br><span class="line">sbit TX = P1^<span class="number">0</span>;</span><br><span class="line">sbit RX = P1^<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">bit timer_sonic_enable;</span><br><span class="line">u16 timer_sonic;				<span class="comment">// 自定义timer</span></span><br><span class="line">bit timer_sonic_tf;				<span class="comment">// 可以通过自定义TF来实现自定义的溢出标志触发条件</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> timer_sonic_update_delay 100 <span class="comment">// ms</span></span></span><br><span class="line">u8 timer_sonic_update;			<span class="comment">// 超声波测距不要频繁调用，要间隔一段时间再去更新，不然数值会一直飘动</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 加括号是因为长得好看。</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> sonic_nops() _nop_(); _nop_(); _nop_(); _nop_(); _nop_(); _nop_(); _nop_(); _nop_();	<span class="comment">// 8 _nop_();</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sonic_send_signal</span><span class="params">()</span> &#123;</span><br><span class="line">	u8 i;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; ++i) &#123;</span><br><span class="line">		TX = <span class="number">1</span>;</span><br><span class="line">		sonic_nops();</span><br><span class="line">		TX = <span class="number">0</span>;</span><br><span class="line">		sonic_nops();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> <span class="title function_">sonic_get_dist</span><span class="params">()</span> &#123;	<span class="comment">// <span class="doctag">NOTE:</span> 实际上，这里的任务可以做进一步的拆分，将开启时钟的任务和等待RX==1的任务拆分开，实现时间资源的优化。但没必要。</span></span><br><span class="line">	sonic_send_signal();</span><br><span class="line">	timer_sonic = <span class="number">0</span>;</span><br><span class="line">	timer_sonic_tf = <span class="number">0</span>;</span><br><span class="line">	timer_sonic_enable = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">while</span> ( (RX == <span class="number">1</span>) &amp;&amp; (timer_sonic_tf == <span class="number">0</span>) );</span><br><span class="line">	timer_sonic_enable = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">// 正常接收到信号</span></span><br><span class="line">	<span class="keyword">if</span> (timer_sonic_tf == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> timer_sonic * <span class="number">8.5e-1</span>;	<span class="comment">// timer_sonic * 50e-6(timer1周期) * 340 * 100 / 2 -&gt; cm</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 时钟技术溢出，超时，中断标志清零，返回999.0f</span></span><br><span class="line">	timer_sonic_tf = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">999.0f</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span>  <span class="comment">// 红外线</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 我不太明白，不过学习了https://blog.csdn.net/weixin_43444989/article/details/89302008</span></span><br><span class="line"></span><br><span class="line">sbit infrared = P1^<span class="number">1</span>;</span><br><span class="line">bit infrared_flag;</span><br><span class="line"></span><br><span class="line">u8 irfrared_buf[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">infrared_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	<span class="comment">// AUXR &amp;= 0x7F;</span></span><br><span class="line">	infrared = <span class="number">1</span>;</span><br><span class="line">	TMOD = (TMOD &amp; <span class="number">0xF0</span>) | <span class="number">0x01</span>;	<span class="comment">// <span class="doctag">TODO:</span> 这是什么意思？</span></span><br><span class="line">	TR0 = <span class="number">0</span>;</span><br><span class="line">	ET0 = <span class="number">0</span>;</span><br><span class="line">	IT0 = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">u16 <span class="title function_">infrared_get_high_time</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	TL0 = <span class="number">0</span>;</span><br><span class="line">	TH0 = <span class="number">0</span>;</span><br><span class="line">	TR0 = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">while</span> (infrared) &#123;</span><br><span class="line">		<span class="keyword">if</span> (TH1 &gt;= <span class="number">0x40</span>) &#123;</span><br><span class="line">			<span class="comment">// 高电平持续时长超过18ms则跳出</span></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	TR0 = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> (TH1 &lt;&lt; <span class="number">8</span> | TL1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">u16 <span class="title function_">infrared_get_high_time</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	TL0 = <span class="number">0</span>;</span><br><span class="line">	TH0 = <span class="number">0</span>;</span><br><span class="line">	TR0 = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">while</span> (!infrared) &#123;</span><br><span class="line">		<span class="keyword">if</span> (TH1 &gt;= <span class="number">0x40</span>) &#123;</span><br><span class="line">			<span class="comment">// 高电平持续时长超过18ms则跳出</span></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	TR0 = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> (TH1 &lt;&lt; <span class="number">8</span> | TL1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// P3.2/INT0，P3.3/INT1，此处需要使用的是INT1</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">int1_int</span><span class="params">(<span class="type">void</span>)</span> interrupt 2 &#123;</span><br><span class="line">	u8 i, j;</span><br><span class="line">	u8 one_byte;</span><br><span class="line">	u16 durance;</span><br><span class="line">	</span><br><span class="line">	durance = infrared_get_low_time();</span><br><span class="line">	<span class="keyword">if</span> ( (durance &lt; <span class="number">7833</span>) || (durance &gt; <span class="number">8755</span>) ) &#123; 	<span class="comment">// WTF is this?		//判断是否为误码</span></span><br><span class="line">		IE0 = <span class="number">0</span>;	<span class="comment">// 手动清除外部中断标志</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	durance = infrared_get_high_time();</span><br><span class="line">	<span class="keyword">if</span> ( (durance &lt; <span class="number">3686</span>) || (durance &gt; <span class="number">3608</span>) ) &#123;  	<span class="comment">// WTF is this?		//判断是否为误码</span></span><br><span class="line">		IE0 = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i) &#123;	<span class="comment">// 4字节</span></span><br><span class="line">		<span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">8</span>; ++j) &#123;	<span class="comment">// 8个比特位</span></span><br><span class="line">			durance = infrared_get_low_time();</span><br><span class="line">			<span class="keyword">if</span> ( (durance &lt; <span class="number">313</span>) || (durance &gt; <span class="number">718</span>) ) &#123;</span><br><span class="line">				IE1 = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			durance = infrared_get_high_time();</span><br><span class="line">			<span class="keyword">if</span> ( (durance &lt; <span class="number">313</span>) || (durance &gt; <span class="number">718</span>) ) &#123;</span><br><span class="line">				<span class="comment">// 0</span></span><br><span class="line">				one_byte &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">				<span class="comment">// one_byte |= 0x00;</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> ( (durance &lt; <span class="number">1345</span>) || (durance &gt; <span class="number">1751</span>) ) &#123;</span><br><span class="line">				<span class="comment">// 1</span></span><br><span class="line">				one_byte &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">				one_byte |= <span class="number">0x80</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">// 不符合上述两种条件，误码</span></span><br><span class="line">				IE0 = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		infrared_buf[i] = one_byte;</span><br><span class="line">	&#125;</span><br><span class="line">	infrared_flag = <span class="number">1</span>;	<span class="comment">// 数据接收完毕</span></span><br><span class="line">	IE0 = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>	<span class="comment">// use_sonic</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 解题变量区</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pcf_reg 0x43</span></span><br><span class="line"><span class="comment">// #define pcf_light 0x41</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 频率</span></span><br><span class="line">u16 freq;</span><br><span class="line">u16 para_freq;			<span class="comment">// Hz</span></span><br><span class="line">u16 freq_counter;</span><br><span class="line">u16 timer_freq;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 湿度</span></span><br><span class="line">u16 humidity;</span><br><span class="line">u16 para_humidity;		<span class="comment">// 1%RH</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 距离</span></span><br><span class="line">u16 distance;</span><br><span class="line">u16 para_distance;		<span class="comment">// cm</span></span><br><span class="line"></span><br><span class="line">bit relay_statue;		<span class="comment">// 继电器吸合状态，若为 1 则为吸合；否则断开</span></span><br><span class="line">u8 relay_counter;		<span class="comment">// 继电器开关次数</span></span><br><span class="line"></span><br><span class="line">bit motor_output_statue;<span class="comment">// 电机现在应该是高电平还是低电平</span></span><br><span class="line">bit motor_is_80;		<span class="comment">// 是否应该为 80% 占空比的信号输出</span></span><br><span class="line"></span><br><span class="line">u8 n_buf;				<span class="comment">// n_motor &amp; n_relay 输出时对应的 P0 引脚的值</span></span><br><span class="line">u8 timer_n_statue;		<span class="comment">// n_buf 更新计时timer，应该 200ns 更新一次 timer_n_statue 的状态。</span></span><br><span class="line"></span><br><span class="line">u16 timer_s7;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">timer0_init</span><span class="params">(<span class="type">void</span>)</span>		<span class="comment">//1毫秒@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">	AUXR |= <span class="number">0x80</span>;			<span class="comment">//定时器时钟1T模式</span></span><br><span class="line">	TMOD &amp;= <span class="number">0xF0</span>;			<span class="comment">//设置定时器模式</span></span><br><span class="line">	TMOD |= <span class="number">0x04</span>;			<span class="comment">// 外部中断</span></span><br><span class="line">	TL0 = <span class="number">0xFF</span>;				<span class="comment">//设置定时初始值</span></span><br><span class="line">	TH0 = <span class="number">0xFF</span>;				<span class="comment">//设置定时初始值</span></span><br><span class="line">	TF0 = <span class="number">0</span>;				<span class="comment">//清除TF0标志</span></span><br><span class="line">	TR0 = <span class="number">1</span>;				<span class="comment">//定时器0开始计时</span></span><br><span class="line">	ET0 = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">timer1_init</span><span class="params">(<span class="type">void</span>)</span>		<span class="comment">//50ns@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">	AUXR |= <span class="number">0x40</span>;			<span class="comment">//定时器时钟1T模式</span></span><br><span class="line">	TMOD &amp;= <span class="number">0x0F</span>;			<span class="comment">//设置定时器模式</span></span><br><span class="line">	TL1 = <span class="number">0xA8</span>;				<span class="comment">//设置定时初始值</span></span><br><span class="line">	TH1 = <span class="number">0xFD</span>;				<span class="comment">//设置定时初始值</span></span><br><span class="line">	TF1 = <span class="number">0</span>;				<span class="comment">//清除TF1标志</span></span><br><span class="line">	TR1 = <span class="number">1</span>;				<span class="comment">//定时器1开始计时</span></span><br><span class="line">	ET1 = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_freq_hz</span><span class="params">(<span class="type">void</span>)</span> &#123;		<span class="comment">// hz</span></span><br><span class="line">	nt_buf[<span class="number">0</span>] = <span class="number">0x0F</span>;</span><br><span class="line">	nt_buf[<span class="number">1</span>] = nt_blank;</span><br><span class="line">	nt_buf_show_blank(<span class="number">7</span>, freq, <span class="number">6</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_freq_khz</span><span class="params">(<span class="type">void</span>)</span> &#123;		<span class="comment">// khz</span></span><br><span class="line">	nt_buf[<span class="number">0</span>] = <span class="number">0x0F</span>;</span><br><span class="line">	nt_buf[<span class="number">1</span>] = nt_blank;</span><br><span class="line">	nt_buf_show_dot_blank(<span class="number">7</span>, freq / <span class="number">100</span>, <span class="number">6</span>, <span class="number">6</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_humidity</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	nt_buf[<span class="number">0</span>] = nt_h;</span><br><span class="line">	nt_buf[<span class="number">1</span>] = nt_buf[<span class="number">2</span>] = nt_buf[<span class="number">3</span>] = nt_buf[<span class="number">4</span>] = nt_buf[<span class="number">5</span>] = nt_blank;</span><br><span class="line">	nt_buf_show_len(<span class="number">7</span>, humidity, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_distance_cm</span><span class="params">(<span class="type">void</span>)</span> &#123;		<span class="comment">// cm</span></span><br><span class="line">	nt_buf[<span class="number">0</span>] = <span class="number">0x0A</span>;</span><br><span class="line">	nt_buf[<span class="number">1</span>] = nt_buf[<span class="number">2</span>] = nt_buf[<span class="number">3</span>] = nt_buf[<span class="number">4</span>] = nt_blank;</span><br><span class="line">	nt_buf_show_blank(<span class="number">7</span>, distance, <span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_distance_m</span><span class="params">(<span class="type">void</span>)</span> &#123;		<span class="comment">// m</span></span><br><span class="line">	nt_buf[<span class="number">0</span>] = <span class="number">0x0A</span>;</span><br><span class="line">	nt_buf[<span class="number">1</span>] = nt_buf[<span class="number">2</span>] = nt_buf[<span class="number">3</span>] = nt_buf[<span class="number">4</span>] = nt_blank;</span><br><span class="line">	nt_buf_show_dot(<span class="number">7</span>, distance, <span class="number">3</span>, <span class="number">5</span>);		<span class="comment">// 直接不用管，如果小于100，（以45cm为例）利用自动补0就可以实现0.45这样的显示了。</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_para_freq</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	nt_buf[<span class="number">0</span>] = nt_p;</span><br><span class="line">	nt_buf[<span class="number">1</span>] = <span class="number">0x01</span>;</span><br><span class="line">	nt_buf[<span class="number">2</span>] = nt_buf[<span class="number">3</span>] = nt_buf[<span class="number">4</span>] = nt_blank;</span><br><span class="line">	nt_buf_show_dot_blank(<span class="number">7</span>, para_freq / <span class="number">100</span>, <span class="number">3</span>, <span class="number">6</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_para_humidity</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	nt_buf[<span class="number">0</span>] = nt_p;</span><br><span class="line">	nt_buf[<span class="number">1</span>] = <span class="number">0x02</span>;</span><br><span class="line">	nt_buf[<span class="number">2</span>] = nt_buf[<span class="number">3</span>] = nt_buf[<span class="number">4</span>] = nt_buf[<span class="number">5</span>] = nt_blank;</span><br><span class="line">	nt_buf_show_len(<span class="number">7</span>, para_humidity, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_para_distance</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	nt_buf[<span class="number">0</span>] = nt_p;</span><br><span class="line">	nt_buf[<span class="number">1</span>] = <span class="number">0x03</span>;</span><br><span class="line">	nt_buf[<span class="number">2</span>] = nt_buf[<span class="number">3</span>] = nt_buf[<span class="number">4</span>] = nt_buf[<span class="number">5</span>] = nt_blank;</span><br><span class="line">	nt_buf_show_dot(<span class="number">7</span>, para_distance / <span class="number">10</span>, <span class="number">2</span>, <span class="number">6</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">u8 interface;</span><br><span class="line">u8 interface_freq;</span><br><span class="line">u8 interface_distance;</span><br><span class="line">u8 interface_para;</span><br><span class="line"></span><br><span class="line">u16 timer_l1;</span><br><span class="line">u16 timer_l2;</span><br><span class="line">u16 timer_l3;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="keyword">switch</span> (interface) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">			<span class="keyword">switch</span> (interface_freq) &#123;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">					draw_freq_hz();</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">					draw_freq_khz();</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">			draw_humidity();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">			<span class="keyword">switch</span> (interface_distance) &#123;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">					draw_distance_cm();</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">					draw_distance_m();</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">			<span class="keyword">switch</span> (interface_para) &#123;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">					draw_para_freq();</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">					draw_para_humidity();</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">					draw_para_distance();</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// led</span></span><br><span class="line">	<span class="comment">// l1</span></span><br><span class="line">	<span class="keyword">if</span> (interface == <span class="number">0</span>) &#123;</span><br><span class="line">		led_on(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (interface == <span class="number">3</span> &amp;&amp; interface_para == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (timer_l1 == <span class="number">0</span>) &#123;</span><br><span class="line">			timer_l1 = <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (timer_l1 &gt;= <span class="number">100</span>) &#123;</span><br><span class="line">			led_inv(<span class="number">0</span>);</span><br><span class="line">			timer_l1 = <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// l2</span></span><br><span class="line">	<span class="keyword">if</span> (interface == <span class="number">1</span>) &#123;</span><br><span class="line">		led_on(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (interface == <span class="number">3</span> &amp;&amp; interface_para == <span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (timer_l2 == <span class="number">0</span>) &#123;</span><br><span class="line">			timer_l2 = <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (timer_l2 &gt;= <span class="number">100</span>) &#123;</span><br><span class="line">			led_inv(<span class="number">1</span>);</span><br><span class="line">			timer_l2 = <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// l3</span></span><br><span class="line">	<span class="keyword">if</span> (interface == <span class="number">2</span>) &#123;</span><br><span class="line">		led_on(<span class="number">2</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (interface == <span class="number">3</span> &amp;&amp; interface_para == <span class="number">2</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (timer_l3 == <span class="number">0</span>) &#123;</span><br><span class="line">			timer_l3 = <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (timer_l3 &gt;= <span class="number">100</span>) &#123;</span><br><span class="line">			led_inv(<span class="number">2</span>);</span><br><span class="line">			timer_l3 = <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// l4</span></span><br><span class="line">	<span class="keyword">if</span> (freq &gt; para_freq) &#123;</span><br><span class="line">		led_on(<span class="number">3</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		led_off(<span class="number">3</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// l5</span></span><br><span class="line">	<span class="keyword">if</span> (humidity &gt; para_humidity) &#123;</span><br><span class="line">		led_on(<span class="number">4</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		led_off(<span class="number">4</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// l6</span></span><br><span class="line">	<span class="keyword">if</span> (distance &gt; para_distance) &#123;</span><br><span class="line">		led_on(<span class="number">5</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		led_off(<span class="number">5</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">update</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">float</span> buf_decimal;</span><br><span class="line">	buf_decimal = pcf_read(pcf_reg);</span><br><span class="line">	humidity = buf_decimal * <span class="number">100.0f</span> / <span class="number">5.0f</span>;		<span class="comment">// vol / 5.0V * 100RH%</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (humidity &gt;= <span class="number">80</span>) &#123;</span><br><span class="line">		pcf_write(pcf_reg, <span class="number">255</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (humidity &lt;= para_humidity) &#123;</span><br><span class="line">		pcf_write(pcf_reg, <span class="number">51</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		buf_decimal = <span class="number">1.0f</span> + (<span class="number">1.0f</span> * (humidity - para_humidity)) * <span class="number">4.0f</span> / (<span class="number">80.0f</span> - para_humidity);</span><br><span class="line">		pcf_write(pcf_reg, buf_decimal * <span class="number">255.0f</span> / <span class="number">5.0f</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// sonic &amp; distance</span></span><br><span class="line">	<span class="keyword">if</span> (timer_sonic_update &gt;= timer_sonic_update_delay) &#123;</span><br><span class="line">		distance = sonic_get_dist();</span><br><span class="line">		timer_sonic_update = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// relay更新</span></span><br><span class="line">	<span class="keyword">if</span> (distance &gt; para_distance) &#123;</span><br><span class="line">		<span class="keyword">if</span> (relay_statue == <span class="number">0</span>) &#123;</span><br><span class="line">			relay_counter++;</span><br><span class="line">			e2prom_set_addr(<span class="number">0x00</span>);</span><br><span class="line">			e2prom_write(&amp;relay_counter, <span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		relay_statue = <span class="number">1</span>;</span><br><span class="line">		n_buf |= <span class="number">0x20</span>;		<span class="comment">// 1 &lt;&lt; 5;</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		relay_statue = <span class="number">0</span>;</span><br><span class="line">		n_buf &amp;= <span class="number">0xDF</span>;		<span class="comment">// ^(1 &lt;&lt; 5);</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// pwm</span></span><br><span class="line">	<span class="keyword">if</span> (freq &gt; para_freq) &#123;</span><br><span class="line">		motor_is_80 = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		motor_is_80 = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (timer_s7 &gt;= <span class="number">1000</span>) &#123;</span><br><span class="line">		timer_s7 = <span class="number">0</span>;</span><br><span class="line">		relay_counter = <span class="number">0</span>;</span><br><span class="line">		e2prom_set_addr(<span class="number">0x00</span>);</span><br><span class="line">		e2prom_write(&amp;relay_counter, <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">key_event</span><span class="params">(u8 key)</span> &#123;</span><br><span class="line">	<span class="type">static</span> bit press_flag = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (timer_key &lt; <span class="number">50</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	timer_key = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">switch</span> (key) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">13</span>:	<span class="comment">// S4</span></span><br><span class="line">			<span class="keyword">if</span> (press_flag == <span class="number">1</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			press_flag = <span class="number">1</span>;</span><br><span class="line">			timer_s7 = <span class="number">0</span>;			<span class="comment">// 见S7部分同样代码的注释</span></span><br><span class="line">			</span><br><span class="line">			interface++;</span><br><span class="line">			interface %= <span class="number">4</span>;</span><br><span class="line">			interface_freq = <span class="number">0</span>;		<span class="comment">// 直接暴力地将其他 interface_xxx 全部置零</span></span><br><span class="line">			interface_distance = <span class="number">0</span>;</span><br><span class="line">			interface_para = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">			</span><br><span class="line">		<span class="keyword">case</span> <span class="number">9</span>:		<span class="comment">// S5</span></span><br><span class="line">			<span class="keyword">if</span> (press_flag == <span class="number">1</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			press_flag = <span class="number">1</span>;</span><br><span class="line">			timer_s7 = <span class="number">0</span>;</span><br><span class="line">			</span><br><span class="line">			interface_para++;</span><br><span class="line">			interface_para %= <span class="number">3</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">			</span><br><span class="line">		<span class="keyword">case</span> <span class="number">5</span>:	<span class="comment">// S6</span></span><br><span class="line">			<span class="keyword">if</span> (press_flag == <span class="number">1</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			press_flag = <span class="number">1</span>;</span><br><span class="line">			timer_s7 = <span class="number">0</span>;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span> (interface == <span class="number">2</span>) &#123;</span><br><span class="line">				interface_distance = !interface_distance;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (interface == <span class="number">3</span>) &#123;</span><br><span class="line">				<span class="comment">// <span class="doctag">TODO:</span> 限制参数范围</span></span><br><span class="line">				<span class="comment">// <span class="doctag">NOTE:</span> 鸽了</span></span><br><span class="line">				<span class="keyword">switch</span> (interface_para) &#123;</span><br><span class="line">					<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">						para_freq += <span class="number">500</span>;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">						para_humidity += <span class="number">10</span>;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">						para_distance += <span class="number">10</span>;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">			</span><br><span class="line">		<span class="keyword">case</span> <span class="number">1</span>:		<span class="comment">// S7</span></span><br><span class="line">			<span class="keyword">if</span> (press_flag == <span class="number">1</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			press_flag = <span class="number">1</span>;</span><br><span class="line">			timer_s7 = <span class="number">0</span>;			<span class="comment">// 这个东西要放到所有的press_flag=1之后去，一来是防错，二来是……</span></span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span> (interface == <span class="number">0</span>) &#123;</span><br><span class="line">				interface_freq = !interface_freq;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (interface == <span class="number">3</span>) &#123;</span><br><span class="line">				<span class="comment">// <span class="doctag">TODO:</span> 限制参数范围</span></span><br><span class="line">				<span class="comment">// <span class="doctag">NOTE:</span> 鸽了</span></span><br><span class="line">				<span class="keyword">switch</span> (interface_para) &#123;</span><br><span class="line">					<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">						para_freq -= <span class="number">500</span>;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">						para_humidity -= <span class="number">10</span>;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">						para_distance -= <span class="number">10</span>;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (interface == <span class="number">1</span>) &#123;</span><br><span class="line">				<span class="keyword">if</span> (timer_s7 == <span class="number">0</span>) &#123;</span><br><span class="line">					timer_s7 = <span class="number">1</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">			</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			press_flag = <span class="number">0</span>;</span><br><span class="line">			timer_s7 = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	write_0xff(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0xFF</span>);</span><br><span class="line">	write_0x00(<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0x00</span>);</span><br><span class="line">	write_0x00(<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0x00</span>);</span><br><span class="line">	write_0xff(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0xFF</span>);</span><br><span class="line">	</span><br><span class="line">	init_ds18b20();</span><br><span class="line">	pcf_write(pcf_reg, <span class="number">51</span>);	<span class="comment">// 51(dec) -&gt; 1.0V</span></span><br><span class="line">	</span><br><span class="line">	timer0_init();</span><br><span class="line">	timer1_init();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Write_Ds1302_Byte(ds1302_w_reg_hour, 0x16);</span></span><br><span class="line">	<span class="comment">// Write_Ds1302_Byte(ds1302_w_reg_minute, 0x59);</span></span><br><span class="line">	<span class="comment">// Write_Ds1302_Byte(ds1302_w_reg_second, 0x50);</span></span><br><span class="line">	</span><br><span class="line">	para_freq = <span class="number">9000</span>;</span><br><span class="line">	para_humidity = <span class="number">40</span>;</span><br><span class="line">	para_distance = <span class="number">60</span>;</span><br><span class="line">	n_buf = <span class="number">0x00</span>;</span><br><span class="line">	</span><br><span class="line">	EA = <span class="number">1</span>;		<span class="comment">// 差点儿忘了这个</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	init();</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">		draw();</span><br><span class="line">		update();</span><br><span class="line">		key_event(keys_btn());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">timer0_int</span><span class="params">(<span class="type">void</span>)</span> interrupt 1 &#123;</span><br><span class="line">	freq_counter++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意：我们最好保证write_0x00()和write_0xff()都只在某一个“进程”中被调用，</span></span><br><span class="line"><span class="comment">// 这样可以避免资源抢占的问题。</span></span><br><span class="line"><span class="comment">// 而状态的更改都通过buffer来完成</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">timer1_int</span><span class="params">(<span class="type">void</span>)</span> interrupt 3 &#123;</span><br><span class="line">	<span class="type">static</span> u8 timer1_100ns_counter = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">// 这里为了保证原来的代码的适用性和通用性</span></span><br><span class="line">	<span class="comment">// 我在修改了TL1和TH1后</span></span><br><span class="line">	<span class="comment">// timer1_100ns_counter每计几个个数，也就是每隔5个200ns后，再去触发原来那些每1ms执行一次的代码。</span></span><br><span class="line">	<span class="comment">// 1ms per cycle</span></span><br><span class="line">	<span class="keyword">if</span> (timer1_100ns_counter == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">// key</span></span><br><span class="line">		timer_key++;</span><br><span class="line">		<span class="comment">// nt</span></span><br><span class="line">		nt_index %= <span class="number">8</span>;</span><br><span class="line">		<span class="keyword">if</span> (nt_buf[nt_index] &amp; <span class="number">0x80</span>) &#123;</span><br><span class="line">			nt_show_dot(nt_index, nt_buf[nt_index] &amp; <span class="number">0x7F</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			nt_show(nt_index, nt_buf[nt_index]);</span><br><span class="line">		&#125;</span><br><span class="line">		nt_index++;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// frequence</span></span><br><span class="line">		timer_freq++;</span><br><span class="line">		<span class="keyword">if</span> (timer_freq &gt;= <span class="number">1000</span>) &#123;</span><br><span class="line">			freq = freq_counter;</span><br><span class="line">			freq_counter = <span class="number">0</span>;</span><br><span class="line">			timer_freq = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// S7长按</span></span><br><span class="line">		<span class="keyword">if</span> (timer_s7 &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			timer_s7++;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// sonic update delay</span></span><br><span class="line">		timer_sonic_update++;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// sonic timer</span></span><br><span class="line">	<span class="keyword">if</span> (timer_sonic_enable == <span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (timer_sonic &gt;= <span class="number">100</span>) &#123;	<span class="comment">// 10ms</span></span><br><span class="line">			timer_sonic_tf = <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			timer_sonic++;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// n_staute, 200us per cycle</span></span><br><span class="line">	<span class="keyword">if</span> (timer1_100ns_counter % <span class="number">4</span> == <span class="number">0</span>) &#123;</span><br><span class="line">		write_0x00(<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, n_buf);</span><br><span class="line">		timer_n_statue++;</span><br><span class="line">		timer_n_statue %= <span class="number">5</span>;</span><br><span class="line">		<span class="keyword">if</span> (motor_is_80) &#123;	<span class="comment">// 80%</span></span><br><span class="line">			<span class="keyword">if</span> (timer_n_statue &gt;= <span class="number">4</span>) &#123;</span><br><span class="line">				n_buf &amp;= <span class="number">0xBF</span>;			<span class="comment">// 低电平</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				n_buf |= <span class="number">0x40</span>;			<span class="comment">// 高电平</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;	<span class="comment">// 20%</span></span><br><span class="line">			<span class="keyword">if</span> (timer_n_statue &gt;= <span class="number">4</span>) &#123;</span><br><span class="line">				n_buf |= <span class="number">0x40</span>;			<span class="comment">// 高电平</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				n_buf &amp;= <span class="number">0xBF</span>;			<span class="comment">// 低电平</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	timer1_100ns_counter++;</span><br><span class="line">	timer1_100ns_counter %= <span class="number">20</span>;		<span class="comment">// 50us for 1ms</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="TH14"><a href="#TH14" class="headerlink" title="TH14"></a>TH14</h2><p>注意，继电器那里，锁存器和ULN2003之间并不是完全对应的关系。<br>N_RELAY上边虽然直接对应了一个“5”，但是，看锁存器！！！它对应的是4位（从0开始），所以我们应该写<code>0x10</code>来对应启动它<del>而不是<code>0x20</code></del>。</p>
<h3 id="代码-3"><a href="#代码-3" class="headerlink" title="代码"></a>代码</h3><p>放上我简单调试过的代码，我大概会写一下我的调试过程。没写参数限制。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2024年5月23日重写包括基本代码在内</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stc15.h&quot;</span>			<span class="comment">// 从stc-isp软件中获取stc15.h，不使用reg51.h</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ds1302.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;iic.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;onewire.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;intrins.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">char</span> i8;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> u8;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">int</span> i16;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> u16;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> i32;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> u32;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************************/</span></span><br><span class="line"></span><br><span class="line">i16 factory_adjust;</span><br><span class="line">i16 factory_media;</span><br><span class="line"><span class="type">float</span> factory_dac;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> attach(x, y, z) P25 = (x); P26 = (y); P27 = (z);</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> detach() P27 = 0; P25 = 0; P26 = 0;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> write_0xff(x, y, z, value) P0 = 0xFF; attach(x, y, z); P0 = (value); detach();</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> write_0x00(x, y, z, value) P0 = 0x00; attach(x, y, z); P0 = (value); detach();</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************************/</span></span><br><span class="line"></span><br><span class="line">u8 led_statue;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> led_show() write_0xff(0, 0, 1, (led_statue));</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> led_on(index) led_statue &amp;= 0xFF ^ (1 &lt;&lt; (index)); led_show();</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> led_off(index) led_statue |= 1 &lt;&lt; (index); led_show();</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> led_inv(index) led_statue ^= 1 &lt;&lt; (index); led_show();</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_blank 16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_interval 17 <span class="comment">// 间隔符（中间横杠）</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_h 18</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_p 19</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_u 20</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_l 21</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_n 22</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_top 23		<span class="comment">// 顶部横杠</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_bottom 24	<span class="comment">// 底部横杠</span></span></span><br><span class="line"></span><br><span class="line">code u8 nt_code[] = &#123;<span class="number">0xc0</span>,<span class="number">0xf9</span>,<span class="number">0xa4</span>,<span class="number">0xb0</span>,<span class="number">0x99</span>,<span class="number">0x92</span>,<span class="number">0x82</span>,<span class="number">0xf8</span>,<span class="number">0x80</span>,<span class="number">0x90</span>,<span class="number">0x88</span>,<span class="number">0x83</span>,<span class="number">0xc6</span>,<span class="number">0xa1</span>,<span class="number">0x86</span>,<span class="number">0x8e</span>,</span><br><span class="line">						  <span class="number">0xFF</span>, <span class="number">0xBF</span>, <span class="number">0x89</span>, <span class="number">0x8C</span>, <span class="number">0xC1</span>, <span class="number">0xC7</span>, <span class="number">0xC8</span>, <span class="number">0xFE</span>, <span class="number">0xF7</span>&#125;;</span><br><span class="line">u8 nt_buf[<span class="number">8</span>] = &#123;nt_blank, nt_blank, nt_blank, nt_blank, nt_blank, nt_blank, nt_blank, nt_blank&#125;;</span><br><span class="line">u8 nt_index;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_draw(pos, index) write_0x00(0, 1, 1, (1 &lt;&lt; (pos))); write_0xff(1, 1, 1, (nt_code[(index)]));</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_draw_dot(pos, index) write_0x00(0, 1, 1, (1 &lt;&lt; (pos)));  write_0xff(1, 1, 1, (nt_code[(index)] &amp; 0x7F));</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_ms</span><span class="params">(u8 ms)</span> &#123;	<span class="comment">//@12.000MHz</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (ms--) &#123;</span><br><span class="line">		<span class="type">unsigned</span> <span class="type">char</span> data i, j;</span><br><span class="line"></span><br><span class="line">		_nop_();</span><br><span class="line">		_nop_();</span><br><span class="line">		i = <span class="number">12</span>;</span><br><span class="line">		j = <span class="number">168</span>;</span><br><span class="line">		<span class="keyword">do</span> &#123;</span><br><span class="line">			<span class="keyword">while</span> (--j);</span><br><span class="line">		&#125; <span class="keyword">while</span> (--i);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_100us</span><span class="params">(<span class="type">void</span>)</span> &#123;	<span class="comment">//@12.000MHz</span></span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> data i, j;</span><br><span class="line"></span><br><span class="line">	i = <span class="number">2</span>;</span><br><span class="line">	j = <span class="number">39</span>;</span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">while</span> (--j);</span><br><span class="line">	&#125; <span class="keyword">while</span> (--i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************************/</span></span><br><span class="line"></span><br><span class="line">u16 timer_key;	<span class="comment">// 在key_event里用于实现消抖、按键释放后再去触发等机制</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 这个框架里给出了独立按键的处理代码。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 扫描按键，注意这里return的与开发板上的按键下标不同。</span></span><br><span class="line"><span class="comment">// 这里采用了最方便用switch写代码的方法去写。</span></span><br><span class="line">u8 <span class="title function_">keys_scan</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	u8 temp = <span class="number">0x00</span>;</span><br><span class="line">	P3 = <span class="number">0x30</span>; P52 = <span class="number">1</span>; P44 = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span> (P3 != <span class="number">0x0C</span> || P42 != <span class="number">0</span> || P44 != <span class="number">0</span>) &#123;</span><br><span class="line">		temp = P3 | (u8)P42 &lt;&lt; <span class="number">6</span> || (u8)P44 &lt;&lt; <span class="number">7</span>;</span><br><span class="line">		<span class="comment">// 可以不考虑在这里消抖，因为我们的key_event()函数里面有。</span></span><br><span class="line">		<span class="comment">// 但是需要delay一个比较短的时间，这是考虑了分布电容</span></span><br><span class="line">		delay_100us(); delay_100us();</span><br><span class="line">		P3 = <span class="number">0x0F</span>; P42 = <span class="number">0</span>; P44 = <span class="number">0</span>;</span><br><span class="line">		delay_100us(); delay_100us();</span><br><span class="line">		temp |= P3;</span><br><span class="line">		<span class="keyword">switch</span> (temp) &#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0x7E</span>: <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xBE</span>: <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xDE</span>: <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xEE</span>: <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0x7D</span>: <span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xBD</span>: <span class="keyword">return</span> <span class="number">6</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xDD</span>: <span class="keyword">return</span> <span class="number">7</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xED</span>: <span class="keyword">return</span> <span class="number">8</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0x7B</span>: <span class="keyword">return</span> <span class="number">9</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xBB</span>: <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xDB</span>: <span class="keyword">return</span> <span class="number">11</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xEB</span>: <span class="keyword">return</span> <span class="number">12</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0x77</span>: <span class="keyword">return</span> <span class="number">13</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xB7</span>: <span class="keyword">return</span> <span class="number">14</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xD7</span>: <span class="keyword">return</span> <span class="number">15</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0xE7</span>: <span class="keyword">return</span> <span class="number">16</span>;</span><br><span class="line">			<span class="keyword">default</span>: <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 独立按键模式</span></span><br><span class="line"><span class="comment">// 4个引脚分别检测，不用switch</span></span><br><span class="line">u8 <span class="title function_">keys_btn</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	P30 = <span class="number">1</span>;</span><br><span class="line">	delay_100us();</span><br><span class="line">	<span class="keyword">if</span> (P30 == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	P31 = <span class="number">1</span>;</span><br><span class="line">	delay_100us();</span><br><span class="line">	<span class="keyword">if</span> (P31 == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	P32 = <span class="number">1</span>;</span><br><span class="line">	delay_100us();</span><br><span class="line">	<span class="keyword">if</span> (P32 == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">9</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	P33 = <span class="number">1</span>;</span><br><span class="line">	delay_100us();</span><br><span class="line">	<span class="keyword">if</span> (P33 == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">13</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 只扫描S4 S5 S8 S9，支持多点按键的方式就是把它们按下的所有坐标都表示一遍</span></span><br><span class="line">u8 <span class="title function_">keys_scan_4</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	u8 temp = <span class="number">0xFF</span>;</span><br><span class="line">	P32 = <span class="number">1</span>; P33 = <span class="number">0</span>;</span><br><span class="line">	P42 = <span class="number">0</span>; P44 = <span class="number">0</span>;</span><br><span class="line">	delay_100us();</span><br><span class="line">	<span class="keyword">if</span> (P32 == <span class="number">0</span>) &#123;</span><br><span class="line">		temp &amp;= <span class="number">0xFB</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	P32 = <span class="number">0</span>; P33 = <span class="number">1</span>;</span><br><span class="line">	delay_100us();</span><br><span class="line">	<span class="keyword">if</span> (P33 == <span class="number">0</span>) &#123;</span><br><span class="line">		temp &amp;= <span class="number">0xF7</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	P32 = <span class="number">0</span>; P33 = <span class="number">0</span>;</span><br><span class="line">	P42 = <span class="number">1</span>; P44 = <span class="number">0</span>;</span><br><span class="line">	delay_100us();</span><br><span class="line">	<span class="keyword">if</span> (P42 == <span class="number">0</span>) &#123;</span><br><span class="line">		temp &amp;= <span class="number">0xBF</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	P42 = <span class="number">0</span>; P44 = <span class="number">1</span>;</span><br><span class="line">	delay_100us();</span><br><span class="line">	<span class="keyword">if</span> (P44 == <span class="number">0</span>) &#123;</span><br><span class="line">		temp &amp;= <span class="number">0x7F</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> temp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 补0</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">nt_buf_draw_len</span><span class="params">(u8 pos, u32 dat, u8 len)</span> &#123;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		nt_buf[pos] = dat % <span class="number">10</span>;</span><br><span class="line">		dat /= <span class="number">10</span>;</span><br><span class="line">		pos--;</span><br><span class="line">	&#125; <span class="keyword">while</span>(--len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 补空白</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">nt_buf_draw_blank</span><span class="params">(u8 pos, u32 dat, u8 len)</span> &#123;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		nt_buf[pos] = dat % <span class="number">10</span>;</span><br><span class="line">		dat /= <span class="number">10</span>;</span><br><span class="line">		pos--;</span><br><span class="line">	&#125; <span class="keyword">while</span>(--len &amp;&amp; dat);</span><br><span class="line">	<span class="keyword">while</span> (len--) &#123;</span><br><span class="line">		nt_buf[pos] = nt_blank;</span><br><span class="line">		pos--;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 补空白补负号</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">nt_buf_draw_blank_minus</span><span class="params">(u8 pos, i32 dat, u8 len)</span> &#123;</span><br><span class="line">	bit is_negative = dat &lt; <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (is_negative) &#123;</span><br><span class="line">		dat = -dat;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		nt_buf[pos] = dat % <span class="number">10</span>;</span><br><span class="line">		dat /= <span class="number">10</span>;</span><br><span class="line">		pos--;</span><br><span class="line">	&#125; <span class="keyword">while</span>(--len &amp;&amp; dat);</span><br><span class="line">	<span class="keyword">if</span> (is_negative) &#123;</span><br><span class="line">		nt_buf[pos] = nt_interval;</span><br><span class="line">		pos--;</span><br><span class="line">		len--;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">while</span> (len--) &#123;</span><br><span class="line">		nt_buf[pos] = nt_blank;</span><br><span class="line">		pos--;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 带小数点，补0</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">nt_buf_draw_dot</span><span class="params">(u8 pos, u32 dat, u8 len, u8 pos_dot)</span> &#123;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		nt_buf[pos] = dat % <span class="number">10</span>;</span><br><span class="line">		dat /= <span class="number">10</span>;</span><br><span class="line">		pos--;</span><br><span class="line">	&#125; <span class="keyword">while</span> (--len);</span><br><span class="line">	nt_buf[pos_dot] |= <span class="number">0x80</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 带小数点，补空白</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">nt_buf_draw_dot_blank</span><span class="params">(u8 pos, u32 dat, u8 len, u8 pos_dot)</span> &#123;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		nt_buf[pos] = dat % <span class="number">10</span>;</span><br><span class="line">		dat /= <span class="number">10</span>;</span><br><span class="line">		pos--;</span><br><span class="line">	&#125; <span class="keyword">while</span> (--len &amp;&amp; dat);</span><br><span class="line">	<span class="keyword">while</span> (len--) &#123;</span><br><span class="line">		nt_buf[pos] = nt_blank;</span><br><span class="line">		pos--;</span><br><span class="line">	&#125;</span><br><span class="line">	nt_buf[pos_dot] |= <span class="number">0x80</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pcf_write</span><span class="params">(u8 ctrl, u8 dat)</span> &#123;</span><br><span class="line">	I2CStart();</span><br><span class="line">	I2CSendByte(<span class="number">0x90</span>);</span><br><span class="line">	I2CWaitAck();</span><br><span class="line">	I2CSendByte(ctrl);</span><br><span class="line">	I2CWaitAck();</span><br><span class="line">	I2CSendByte(dat);</span><br><span class="line">	I2CWaitAck();</span><br><span class="line">	I2CStop();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> <span class="title function_">pcf_read</span><span class="params">(u8 ctrl)</span> &#123;</span><br><span class="line">	u8 res;</span><br><span class="line">	I2CStart();</span><br><span class="line">	I2CSendByte(<span class="number">0x90</span>);</span><br><span class="line">	I2CWaitAck();</span><br><span class="line">	I2CSendByte(ctrl);</span><br><span class="line">	I2CWaitAck();</span><br><span class="line">	I2CStop();</span><br><span class="line">	</span><br><span class="line">	I2CStart();</span><br><span class="line">	I2CSendByte(<span class="number">0x91</span>);</span><br><span class="line">	I2CWaitAck();</span><br><span class="line">	res = I2CReceiveByte();</span><br><span class="line">	I2CSendAck(<span class="number">0</span>);</span><br><span class="line">	I2CStop();</span><br><span class="line">	<span class="keyword">return</span> res * <span class="number">5.0f</span> / <span class="number">255.0f</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ds1302_r_reg_hour 0x85</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ds1302_w_reg_hour 0x84</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ds1302_r_reg_minute 0x83</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ds1302_w_reg_minute 0x82</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ds1302_r_reg_second 0x81</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ds1302_w_reg_second 0x80</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="type">float</span> <span class="title function_">temper_read</span><span class="params">()</span> &#123;</span><br><span class="line">	u16 res = <span class="number">0</span>;</span><br><span class="line">	u8 high, low;</span><br><span class="line">	init_ds18b20();</span><br><span class="line">	Write_DS18B20(<span class="number">0xCC</span>);</span><br><span class="line">	Write_DS18B20(<span class="number">0x44</span>);</span><br><span class="line">	</span><br><span class="line">	init_ds18b20();</span><br><span class="line">	Write_DS18B20(<span class="number">0xCC</span>);</span><br><span class="line">	Write_DS18B20(<span class="number">0xBE</span>);</span><br><span class="line">	</span><br><span class="line">	low = Read_DS18B20();</span><br><span class="line">	high = Read_DS18B20();</span><br><span class="line">	res = high &amp; <span class="number">0x0F</span>;</span><br><span class="line">	res = (res &lt;&lt; <span class="number">8</span>) | low;</span><br><span class="line">	<span class="keyword">return</span> res * <span class="number">0.0625f</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">e2prom_set_addr</span><span class="params">(u8 addr)</span> &#123;</span><br><span class="line">	I2CStart();</span><br><span class="line">	I2CSendByte(<span class="number">0xA0</span>);</span><br><span class="line">	I2CWaitAck();</span><br><span class="line">	I2CSendByte(addr);</span><br><span class="line">	I2CWaitAck();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">e2prom_write</span><span class="params">(u8 *dat, u8 len)</span> &#123;</span><br><span class="line">	u8 i;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; ++i) &#123;</span><br><span class="line">		I2CSendByte(dat[i]);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 多数题目都只是要求我们去读写一字节的东西，所以这里就只写一个单字节读取了。</span></span><br><span class="line"><span class="comment">// 想要扩展成多字节读取，可以参考e2prom_write();</span></span><br><span class="line">u8 <span class="title function_">e2prom_read</span><span class="params">()</span> &#123;</span><br><span class="line">	u8 tmp;</span><br><span class="line">	I2CStart();</span><br><span class="line">	I2CSendByte(<span class="number">0xA1</span>);</span><br><span class="line">	I2CWaitAck();</span><br><span class="line">	tmp = I2CReceiveByte();</span><br><span class="line">	I2CSendAck(<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">return</span> tmp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 串口通信</span></span><br><span class="line"><span class="comment">// #define use_uart</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> use_uart</span></span><br><span class="line"></span><br><span class="line">u8 uart_dat;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">uart_init</span><span class="params">(<span class="type">void</span>)</span> &#123;	<span class="comment">//9600bps@12.000MHz UART1</span></span><br><span class="line"></span><br><span class="line">	SCON = <span class="number">0x50</span>;		<span class="comment">//8位数据,可变波特率</span></span><br><span class="line">	AUXR |= <span class="number">0x40</span>;		<span class="comment">//定时器时钟1T模式</span></span><br><span class="line">	AUXR &amp;= <span class="number">0xFE</span>;		<span class="comment">//串口1选择定时器1为波特率发生器</span></span><br><span class="line">	TMOD &amp;= <span class="number">0x0F</span>;		<span class="comment">//设置定时器模式</span></span><br><span class="line">	TL1 = <span class="number">0xC7</span>;			<span class="comment">//设置定时初始值</span></span><br><span class="line">	TH1 = <span class="number">0xFE</span>;			<span class="comment">//设置定时初始值</span></span><br><span class="line">	ET1 = <span class="number">0</span>;			<span class="comment">//禁止定时器中断</span></span><br><span class="line">	TR1 = <span class="number">1</span>;			<span class="comment">//定时器1开始计时</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">uart_send_byte</span><span class="params">(u8 dat)</span> &#123;</span><br><span class="line">	SBUF = dat;</span><br><span class="line">	<span class="keyword">while</span> (TI == <span class="number">0</span>);</span><br><span class="line">	TI = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">uart_int</span><span class="params">(<span class="type">void</span>)</span> interrupt 4 &#123;</span><br><span class="line">	<span class="keyword">if</span> (RI == <span class="number">1</span>) &#123;</span><br><span class="line">		uart_dat = SBUF;</span><br><span class="line">		RI = <span class="number">0</span>;</span><br><span class="line">		<span class="comment">// do sth else...</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// use_uart</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 超声波和红外线互斥，所以要用个define来实现选用</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> use_sonic	<span class="comment">// 使用超声波</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> use_sonic</span></span><br><span class="line"></span><br><span class="line">sbit TX = P1^<span class="number">0</span>;</span><br><span class="line">sbit RX = P1^<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加括号是因为长得好看。</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> sonic_nops() _nop_(); _nop_(); _nop_(); _nop_(); _nop_(); _nop_(); _nop_(); _nop_();	<span class="comment">// 8 _nop_();</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sonic_send_signal</span><span class="params">()</span> &#123;</span><br><span class="line">	u8 i;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; ++i) &#123;</span><br><span class="line">		TX = <span class="number">1</span>;</span><br><span class="line">		sonic_nops();</span><br><span class="line">		TX = <span class="number">0</span>;</span><br><span class="line">		sonic_nops();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> <span class="title function_">sonic_get_dist</span><span class="params">()</span> &#123;	<span class="comment">// <span class="doctag">NOTE:</span> 实际上，这里的任务可以做进一步的拆分，将开启时钟的任务和等待RX==1的任务拆分开，实现时间资源的优化。但没必要。</span></span><br><span class="line">	u16 timer_sonic;</span><br><span class="line">	sonic_send_signal();</span><br><span class="line">	TL0 = <span class="number">0</span>;</span><br><span class="line">	TH0 = <span class="number">0</span>;</span><br><span class="line">	TR0 = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">while</span> ( (RX == <span class="number">1</span>) &amp;&amp; (TF0 == <span class="number">0</span>) );</span><br><span class="line">	TR0 = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">// 正常接收到信号</span></span><br><span class="line">	<span class="keyword">if</span> (TF0 == <span class="number">0</span>) &#123;</span><br><span class="line">		timer_sonic = TH0;</span><br><span class="line">		timer_sonic = (timer_sonic &lt;&lt; <span class="number">8</span>) | TL0;</span><br><span class="line">		<span class="comment">// timer_sonic * 1 (us) * 1e-6 (us -&gt; s) * 声速(m/s) * 100 (m -&gt; cm) / 2 + 调整量</span></span><br><span class="line">		<span class="keyword">return</span> timer_sonic * <span class="number">1e-6</span> * factory_media * <span class="number">100.0f</span> / <span class="number">2.0f</span> + factory_adjust;</span><br><span class="line">	&#125;</span><br><span class="line">	TF0 = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">999.0f</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span>  <span class="comment">// 红外线</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 我不太明白，不过学习了https://blog.csdn.net/weixin_43444989/article/details/89302008</span></span><br><span class="line"></span><br><span class="line">sbit infrared = P1^<span class="number">1</span>;</span><br><span class="line">bit infrared_flag;</span><br><span class="line"></span><br><span class="line">u8 irfrared_buf[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">infrared_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	<span class="comment">// AUXR &amp;= 0x7F;</span></span><br><span class="line">	infrared = <span class="number">1</span>;</span><br><span class="line">	TMOD = (TMOD &amp; <span class="number">0xF0</span>) | <span class="number">0x01</span>;	<span class="comment">// <span class="doctag">TODO:</span> 这是什么意思？</span></span><br><span class="line">	TR0 = <span class="number">0</span>;</span><br><span class="line">	ET0 = <span class="number">0</span>;</span><br><span class="line">	IT0 = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">u16 <span class="title function_">infrared_get_high_time</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	TL0 = <span class="number">0</span>;</span><br><span class="line">	TH0 = <span class="number">0</span>;</span><br><span class="line">	TR0 = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">while</span> (infrared) &#123;</span><br><span class="line">		<span class="keyword">if</span> (TH1 &gt;= <span class="number">0x40</span>) &#123;</span><br><span class="line">			<span class="comment">// 高电平持续时长超过18ms则跳出</span></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	TR0 = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> (TH1 &lt;&lt; <span class="number">8</span> | TL1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">u16 <span class="title function_">infrared_get_high_time</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	TL0 = <span class="number">0</span>;</span><br><span class="line">	TH0 = <span class="number">0</span>;</span><br><span class="line">	TR0 = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">while</span> (!infrared) &#123;</span><br><span class="line">		<span class="keyword">if</span> (TH1 &gt;= <span class="number">0x40</span>) &#123;</span><br><span class="line">			<span class="comment">// 高电平持续时长超过18ms则跳出</span></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	TR0 = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> (TH1 &lt;&lt; <span class="number">8</span> | TL1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// P3.2/INT0，P3.3/INT1，此处需要使用的是INT1</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">int1_int</span><span class="params">(<span class="type">void</span>)</span> interrupt 2 &#123;</span><br><span class="line">	u8 i, j;</span><br><span class="line">	u8 one_byte;</span><br><span class="line">	u16 durance;</span><br><span class="line">	</span><br><span class="line">	durance = infrared_get_low_time();</span><br><span class="line">	<span class="keyword">if</span> ( (durance &lt; <span class="number">7833</span>) || (durance &gt; <span class="number">8755</span>) ) &#123; 	<span class="comment">// WTF is this?		//判断是否为误码</span></span><br><span class="line">		IE0 = <span class="number">0</span>;	<span class="comment">// 手动清除外部中断标志</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	durance = infrared_get_high_time();</span><br><span class="line">	<span class="keyword">if</span> ( (durance &lt; <span class="number">3686</span>) || (durance &gt; <span class="number">3608</span>) ) &#123;  	<span class="comment">// WTF is this?		//判断是否为误码</span></span><br><span class="line">		IE0 = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i) &#123;	<span class="comment">// 4字节</span></span><br><span class="line">		<span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">8</span>; ++j) &#123;	<span class="comment">// 8个比特位</span></span><br><span class="line">			durance = infrared_get_low_time();</span><br><span class="line">			<span class="keyword">if</span> ( (durance &lt; <span class="number">313</span>) || (durance &gt; <span class="number">718</span>) ) &#123;</span><br><span class="line">				IE1 = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			durance = infrared_get_high_time();</span><br><span class="line">			<span class="keyword">if</span> ( (durance &lt; <span class="number">313</span>) || (durance &gt; <span class="number">718</span>) ) &#123;</span><br><span class="line">				<span class="comment">// 0</span></span><br><span class="line">				one_byte &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">				<span class="comment">// one_byte |= 0x00;</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> ( (durance &lt; <span class="number">1345</span>) || (durance &gt; <span class="number">1751</span>) ) &#123;</span><br><span class="line">				<span class="comment">// 1</span></span><br><span class="line">				one_byte &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">				one_byte |= <span class="number">0x80</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">// 不符合上述两种条件，误码</span></span><br><span class="line">				IE0 = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		infrared_buf[i] = one_byte;</span><br><span class="line">	&#125;</span><br><span class="line">	infrared_flag = <span class="number">1</span>;	<span class="comment">// 数据接收完毕</span></span><br><span class="line">	IE0 = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>	<span class="comment">// use_sonic</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 解题变量区</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pcf_reg 0x43</span></span><br><span class="line"></span><br><span class="line"><span class="type">float</span> temper;</span><br><span class="line"><span class="type">float</span> para_temper;</span><br><span class="line"></span><br><span class="line">i16 distance;</span><br><span class="line">i16 para_distance;</span><br><span class="line"></span><br><span class="line">bit data_ready;</span><br><span class="line">bit dac_output;</span><br><span class="line"></span><br><span class="line">u16 timer_recording;		<span class="comment">// 测距界面按下s8，开启的记录功能</span></span><br><span class="line">u16 timer_s8s9;				<span class="comment">// s8 s9 同时按下</span></span><br><span class="line">u16 timer_l1;				<span class="comment">// l1闪烁</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">timer0_init</span><span class="params">(<span class="type">void</span>)</span>		<span class="comment">//@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">	AUXR &amp;= <span class="number">0x7F</span>;			<span class="comment">//定时器时钟12T模式</span></span><br><span class="line">	TMOD &amp;= <span class="number">0xF0</span>;			<span class="comment">//设置定时器模式</span></span><br><span class="line">	<span class="comment">// TMOD |= 0x04;			// 外部中断</span></span><br><span class="line">	TL0 = <span class="number">0xFF</span>;				<span class="comment">//设置定时初始值</span></span><br><span class="line">	TH0 = <span class="number">0xFF</span>;				<span class="comment">//设置定时初始值</span></span><br><span class="line">	TF0 = <span class="number">0</span>;				<span class="comment">//清除TF0标志</span></span><br><span class="line">	<span class="comment">// TR0 = 1;				//定时器0开始计时</span></span><br><span class="line">	TR0 = <span class="number">0</span>;</span><br><span class="line">	ET0 = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">timer1_init</span><span class="params">(<span class="type">void</span>)</span>		<span class="comment">//1ms@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">	AUXR |= <span class="number">0x40</span>;			<span class="comment">//定时器时钟1T模式</span></span><br><span class="line">	TMOD &amp;= <span class="number">0x0F</span>;			<span class="comment">//设置定时器模式</span></span><br><span class="line">	TL1 = <span class="number">0x20</span>;				<span class="comment">//设置定时初值</span></span><br><span class="line">	TH1 = <span class="number">0xD1</span>;				<span class="comment">//设置定时初值</span></span><br><span class="line">	TF1 = <span class="number">0</span>;				<span class="comment">//清除TF1标志</span></span><br><span class="line">	TR1 = <span class="number">1</span>;				<span class="comment">//定时器1开始计时</span></span><br><span class="line">	ET1 = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************************/</span></span><br><span class="line"></span><br><span class="line">u8 interface;</span><br><span class="line">u8 interface_distance;		<span class="comment">// 0 -&gt; cm; 1 -&gt; m</span></span><br><span class="line">u8 interface_para;</span><br><span class="line">u8 interface_factory;		<span class="comment">// 工厂模式</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_distance</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	nt_buf_draw_dot(<span class="number">2</span>, temper * <span class="number">10.0f</span>, <span class="number">3</span>, <span class="number">1</span>);</span><br><span class="line">	nt_buf[<span class="number">3</span>] = nt_interval;</span><br><span class="line">	nt_buf_draw_blank(<span class="number">7</span>, distance, <span class="number">4</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_distance_m</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	nt_buf_draw_dot(<span class="number">2</span>, temper * <span class="number">10.0f</span>, <span class="number">3</span>, <span class="number">1</span>);</span><br><span class="line">	nt_buf[<span class="number">3</span>] = nt_interval;</span><br><span class="line">	nt_buf_draw_dot_blank(<span class="number">7</span>, distance, <span class="number">4</span>, <span class="number">5</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_para_distance</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	nt_buf[<span class="number">0</span>] = nt_p;</span><br><span class="line">	nt_buf[<span class="number">1</span>] = <span class="number">0x01</span>;</span><br><span class="line">	nt_buf[<span class="number">2</span>] = nt_buf[<span class="number">3</span>] = nt_buf[<span class="number">4</span>] = nt_buf[<span class="number">5</span>] = nt_blank;</span><br><span class="line">	nt_buf_draw_len(<span class="number">7</span>, para_distance, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_para_temper</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	nt_buf[<span class="number">0</span>] = nt_p;</span><br><span class="line">	nt_buf[<span class="number">1</span>] = <span class="number">0x02</span>;</span><br><span class="line">	nt_buf[<span class="number">2</span>] = nt_buf[<span class="number">3</span>] = nt_buf[<span class="number">4</span>] = nt_buf[<span class="number">5</span>] = nt_blank;</span><br><span class="line">	nt_buf_draw_len(<span class="number">7</span>, para_temper, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_factory_adjust</span><span class="params">(<span class="type">void</span>)</span> &#123;	<span class="comment">// 工厂模式-校准</span></span><br><span class="line">	nt_buf[<span class="number">0</span>] = <span class="number">0x0F</span>;</span><br><span class="line">	nt_buf[<span class="number">1</span>] = <span class="number">0x01</span>;</span><br><span class="line">	nt_buf[<span class="number">2</span>] = nt_buf[<span class="number">3</span>] = nt_buf[<span class="number">4</span>] = nt_blank;</span><br><span class="line">	nt_buf_draw_blank_minus(<span class="number">7</span>, factory_adjust, <span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_factory_media</span><span class="params">(<span class="type">void</span>)</span> &#123;		<span class="comment">// 工厂模式-介质</span></span><br><span class="line">	nt_buf[<span class="number">0</span>] = <span class="number">0x0F</span>;</span><br><span class="line">	nt_buf[<span class="number">1</span>] = <span class="number">0x02</span>;</span><br><span class="line">	nt_buf[<span class="number">2</span>] = nt_buf[<span class="number">3</span>] =  nt_blank;</span><br><span class="line">	nt_buf_draw_blank(<span class="number">7</span>, factory_media, <span class="number">4</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_factory_dac</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	nt_buf[<span class="number">0</span>] = <span class="number">0x0F</span>;</span><br><span class="line">	nt_buf[<span class="number">1</span>] = <span class="number">0x03</span>;</span><br><span class="line">	nt_buf[<span class="number">2</span>] = nt_buf[<span class="number">3</span>] = nt_buf[<span class="number">4</span>] = nt_buf[<span class="number">5</span>] = nt_blank;</span><br><span class="line">	nt_buf_draw_dot(<span class="number">7</span>, factory_dac * <span class="number">10.0f</span>, <span class="number">2</span>, <span class="number">6</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="keyword">switch</span> (interface) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">			<span class="comment">// 为什么一定不在draw_distance的代码中添加根据按键要求去显示cm或者是m的功能？</span></span><br><span class="line">			<span class="comment">// 答得好，让我们记忆中的框架足够稳定</span></span><br><span class="line">			<span class="keyword">switch</span> (interface_distance) &#123;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">					draw_distance();</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">					draw_distance_m();</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;		<span class="comment">// Fixed: 这里少了一个break......</span></span><br><span class="line">		<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">			<span class="keyword">switch</span> (interface_para) &#123;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">					draw_para_distance();</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">					draw_para_temper();</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">			<span class="keyword">switch</span> (interface_factory) &#123;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">					draw_factory_adjust();</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">					draw_factory_media();</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">					draw_factory_dac();</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">key_event</span><span class="params">(u8 key)</span> &#123;</span><br><span class="line">	<span class="type">static</span> bit press_flag = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (timer_key &lt; <span class="number">50</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	timer_key = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (timer_recording &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">switch</span> (key) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">0x77</span>:	<span class="comment">// S4</span></span><br><span class="line">			<span class="keyword">if</span> (press_flag == <span class="number">1</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			press_flag = <span class="number">1</span>;</span><br><span class="line">			</span><br><span class="line">			interface++;</span><br><span class="line">			interface %= <span class="number">3</span>;</span><br><span class="line">			interface_para = <span class="number">0</span>;		<span class="comment">// 直接暴力地将其他 interface_xxx 全部置零</span></span><br><span class="line">			interface_factory = <span class="number">0</span>;</span><br><span class="line">			interface_distance = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">			</span><br><span class="line">		<span class="keyword">case</span> <span class="number">0x7B</span>:		<span class="comment">// S5</span></span><br><span class="line">			<span class="keyword">if</span> (press_flag == <span class="number">1</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			press_flag = <span class="number">1</span>;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span> (interface == <span class="number">0</span>) &#123;</span><br><span class="line">				interface_distance = !interface_distance;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (interface == <span class="number">1</span>) &#123;</span><br><span class="line">				interface_para++;</span><br><span class="line">				interface_para %= <span class="number">2</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (interface == <span class="number">2</span>) &#123;		<span class="comment">// Fixed: 写成了 == 3</span></span><br><span class="line">				interface_factory++;</span><br><span class="line">				interface_factory %= <span class="number">3</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">			</span><br><span class="line">		<span class="keyword">case</span> <span class="number">0xB7</span>:	<span class="comment">// S8</span></span><br><span class="line">			<span class="keyword">if</span> (press_flag == <span class="number">1</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			press_flag = <span class="number">1</span>;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span> (interface == <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="keyword">if</span> (timer_recording == <span class="number">0</span>) &#123;</span><br><span class="line">					timer_recording = <span class="number">1</span>;</span><br><span class="line">					dac_output = <span class="number">0</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// <span class="doctag">TODO:</span> 参数范围限制</span></span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (interface == <span class="number">1</span>) &#123;</span><br><span class="line">				<span class="keyword">switch</span> (interface_para) &#123;</span><br><span class="line">					<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">						para_distance += <span class="number">10</span>;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">						para_temper += <span class="number">1</span>;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (interface == <span class="number">2</span>) &#123;</span><br><span class="line">				<span class="keyword">switch</span> (interface_factory) &#123;</span><br><span class="line">					<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">						factory_adjust += <span class="number">5</span>;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">						factory_media += <span class="number">10</span>;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">						factory_dac += <span class="number">0.1f</span>;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">			</span><br><span class="line">		<span class="keyword">case</span> <span class="number">0xBB</span>:		<span class="comment">// S9</span></span><br><span class="line">			<span class="keyword">if</span> (press_flag == <span class="number">1</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			press_flag = <span class="number">1</span>;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// <span class="doctag">TODO:</span> 参数范围限制</span></span><br><span class="line">			<span class="keyword">if</span> (interface == <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="keyword">if</span> (data_ready) &#123;</span><br><span class="line">					dac_output = <span class="number">1</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (interface == <span class="number">1</span>) &#123;</span><br><span class="line">				<span class="keyword">switch</span> (interface_para) &#123;</span><br><span class="line">					<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">						para_distance -= <span class="number">10</span>;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">						para_temper -= <span class="number">1</span>;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (interface == <span class="number">2</span>) &#123;</span><br><span class="line">				<span class="keyword">switch</span> (interface_factory) &#123;</span><br><span class="line">					<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">						factory_adjust -= <span class="number">5</span>;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">						factory_media -= <span class="number">10</span>;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">						factory_dac -= <span class="number">0.1f</span>;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">case</span> <span class="number">0xB3</span>:</span><br><span class="line">			<span class="keyword">if</span> (timer_s8s9 == <span class="number">0</span>) &#123;</span><br><span class="line">				timer_s8s9 = <span class="number">1</span>;</span><br><span class="line">				press_flag = <span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">			</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			press_flag = <span class="number">0</span>;</span><br><span class="line">			timer_s8s9 = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">update_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	interface = <span class="number">0</span>;</span><br><span class="line">	interface_para = <span class="number">0</span>;		<span class="comment">// 直接暴力地将其他 interface_xxx 全部置零</span></span><br><span class="line">	interface_factory = <span class="number">0</span>;</span><br><span class="line">	interface_distance = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	para_distance = <span class="number">40</span>;</span><br><span class="line">	para_temper = <span class="number">30</span>;</span><br><span class="line">	factory_adjust = <span class="number">0</span>;</span><br><span class="line">	factory_media = <span class="number">340.0f</span>;</span><br><span class="line">	factory_dac = <span class="number">1.0f</span>;</span><br><span class="line">	</span><br><span class="line">	temper = <span class="number">0</span>;</span><br><span class="line">	distance = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	data_ready = <span class="number">0</span>;</span><br><span class="line">	dac_output = <span class="number">0</span>;</span><br><span class="line">	timer_recording = <span class="number">0</span>;</span><br><span class="line">	timer_l1 = <span class="number">0</span>;</span><br><span class="line">	timer_s8s9 = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	write_0x00(<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0x00</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">update</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (timer_s8s9 &gt; <span class="number">2000</span>) &#123;</span><br><span class="line">		timer_s8s9 = <span class="number">0</span>;</span><br><span class="line">		update_init();</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (timer_recording &gt; <span class="number">0</span> &amp;&amp; timer_recording &lt;= <span class="number">6000</span>) &#123;</span><br><span class="line">		distance = sonic_get_dist();</span><br><span class="line">		temper = temper_read();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (timer_recording &gt; <span class="number">6000</span>) &#123;</span><br><span class="line">		timer_recording = <span class="number">0</span>;</span><br><span class="line">		data_ready = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (dac_output) &#123;</span><br><span class="line">		<span class="keyword">if</span> (distance &lt; <span class="number">10</span>) &#123;</span><br><span class="line">			pcf_write(pcf_reg, factory_dac * <span class="number">255.0f</span> / <span class="number">5.0f</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (distance &gt; <span class="number">90</span>) &#123;</span><br><span class="line">			pcf_write(pcf_reg, <span class="number">255</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			pcf_write(pcf_reg, (<span class="number">5.0f</span> - factory_dac) / <span class="number">80.0f</span> * (distance - <span class="number">10.0f</span>) + factory_dac);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		pcf_write(pcf_reg, <span class="number">0x00</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	write_0xff(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0xFF</span>);</span><br><span class="line">	write_0x00(<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0x00</span>);</span><br><span class="line">	write_0x00(<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0x00</span>);</span><br><span class="line">	write_0xff(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0xFF</span>);</span><br><span class="line">	</span><br><span class="line">	init_ds18b20();</span><br><span class="line">	pcf_write(pcf_reg, <span class="number">0</span>);</span><br><span class="line">	</span><br><span class="line">	timer0_init();</span><br><span class="line">	timer1_init();</span><br><span class="line">	</span><br><span class="line">	para_distance = <span class="number">40</span>;</span><br><span class="line">	para_temper = <span class="number">30</span>;</span><br><span class="line">	factory_adjust = <span class="number">0.0f</span>;</span><br><span class="line">	factory_media = <span class="number">340</span>;</span><br><span class="line">	factory_dac = <span class="number">1.0f</span>;</span><br><span class="line">	</span><br><span class="line">	EA = <span class="number">1</span>;		<span class="comment">// 差点儿忘了这个</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	init();</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">		draw();</span><br><span class="line">		update();</span><br><span class="line">		key_event(keys_scan_4());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">void timer0_int(void) interrupt 1 &#123;</span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">timer1_int</span><span class="params">(<span class="type">void</span>)</span> interrupt 3 &#123;</span><br><span class="line">	<span class="comment">// nt</span></span><br><span class="line">	nt_index %= <span class="number">8</span>;</span><br><span class="line">	<span class="keyword">if</span> (nt_buf[nt_index] &amp; <span class="number">0x80</span>) &#123;</span><br><span class="line">		nt_draw_dot(nt_index, nt_buf[nt_index] &amp; <span class="number">0x7F</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		nt_draw(nt_index, nt_buf[nt_index]);</span><br><span class="line">	&#125;</span><br><span class="line">	nt_index++;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// key</span></span><br><span class="line">	timer_key++;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (timer_l1 &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		timer_l1++;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (timer_recording &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		timer_recording++;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (timer_s8s9 &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		timer_s8s9++;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 继电器</span></span><br><span class="line">	<span class="keyword">if</span> (distance &gt;= para_distance - <span class="number">5</span> &amp;&amp; distance &lt;= para_distance + <span class="number">5</span> &amp;&amp; temper &lt; para_temper) &#123;</span><br><span class="line">		write_0x00(<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0x10</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		write_0x00(<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0x00</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// led</span></span><br><span class="line">	<span class="keyword">if</span> (interface == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (distance &gt;= <span class="number">255</span>) &#123;</span><br><span class="line">			led_statue = <span class="number">0x00</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			led_statue = ~distance;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (interface == <span class="number">1</span>) &#123;</span><br><span class="line">		led_statue = <span class="number">0x7F</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (interface == <span class="number">2</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (timer_l1 == <span class="number">0</span>) &#123;</span><br><span class="line">			timer_l1 = <span class="number">1</span>;</span><br><span class="line">			led_statue = <span class="number">0xFF</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (timer_l1 &gt;= <span class="number">100</span>) &#123;</span><br><span class="line">			led_inv(<span class="number">0</span>);</span><br><span class="line">			timer_l1 = <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		timer_l1 = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	led_show();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="模拟训练实录"><a href="#模拟训练实录" class="headerlink" title="模拟训练实录"></a>模拟训练实录</h1><p>为了避免省赛期间的种种问题再次发生，我决定做一次模拟训练加强巩固所学内容。</p>
<p>模拟训练的日期定在了一个周四，5.30。</p>
<h2 id="手搓框架"><a href="#手搓框架" class="headerlink" title="手搓框架"></a>手搓框架</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stc89xx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;intrins.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;iic.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ds1302.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;onewire.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">char</span> i8;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> u8;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">int</span> i16;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> u16;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> i32;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> u32;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> attach(x, y) P27 = 0; P25 = (x); P26 = (y); P27 = 1;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> detach() P27 = 0;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> write_0x00(x, y, val) P0 = 0x00; attach(x, y); P0 = (val); detach();</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> write_0xff(x, y, val) P0 = 0xFF; attach(x, y); P0 = (val); detach();</span></span><br><span class="line"></span><br><span class="line">u8 led_statue = <span class="number">0xFF</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> led_show() write_0xff(0, 0, led_statue);</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> led_on(index) led_statue &amp;= ~(1 &lt;&lt; (index));</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> led_off(index) led_statue |= 1 &lt;&lt; (index);</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> led_inv(index) led_statue ^= 1 &lt;&lt; (index);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/****************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delay_100us</span><span class="params">()</span>		<span class="comment">//@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> i, j;</span><br><span class="line"></span><br><span class="line">	i = <span class="number">2</span>;</span><br><span class="line">	j = <span class="number">39</span>;</span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">while</span> (--j);</span><br><span class="line">	&#125; <span class="keyword">while</span> (--i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/****************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_blank 16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_top 17</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_mid 18</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_bot 19</span></span><br><span class="line">code u8 nt_code[] = </span><br><span class="line">&#123;</span><br><span class="line">	<span class="number">0xc0</span>, <span class="comment">//0</span></span><br><span class="line">	<span class="number">0xf9</span>, <span class="comment">//1</span></span><br><span class="line">	<span class="number">0xa4</span>, <span class="comment">//2</span></span><br><span class="line">	<span class="number">0xb0</span>, <span class="comment">//3</span></span><br><span class="line">	<span class="number">0x99</span>, <span class="comment">//4</span></span><br><span class="line">	<span class="number">0x92</span>, <span class="comment">//5</span></span><br><span class="line">	<span class="number">0x82</span>, <span class="comment">//6</span></span><br><span class="line">	<span class="number">0xf8</span>, <span class="comment">//7</span></span><br><span class="line">	<span class="number">0x80</span>, <span class="comment">//8</span></span><br><span class="line">	<span class="number">0x90</span>, <span class="comment">//9</span></span><br><span class="line">	<span class="number">0x88</span>, <span class="comment">//A</span></span><br><span class="line">	<span class="number">0x83</span>, <span class="comment">//b</span></span><br><span class="line">	<span class="number">0xc6</span>, <span class="comment">//C</span></span><br><span class="line">	<span class="number">0xa1</span>, <span class="comment">//d</span></span><br><span class="line">	<span class="number">0x86</span>, <span class="comment">//E</span></span><br><span class="line">	<span class="number">0x8e</span>, <span class="comment">//F</span></span><br><span class="line">	<span class="number">0xFF</span>,	<span class="comment">// nt_blank</span></span><br><span class="line">	<span class="number">0xFE</span>,	<span class="comment">// nt_top</span></span><br><span class="line">	<span class="number">0xBF</span>,	<span class="comment">// nt_mid</span></span><br><span class="line">	<span class="number">0xF7</span>	<span class="comment">// nt_bot(bottom)</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">u8 nt_buf[] = &#123;nt_blank, nt_blank, nt_blank, nt_blank, nt_blank, nt_blank, nt_blank, nt_blank&#125;;</span><br><span class="line">u8 nt_index;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> nt_show(index) write_0x00(0, 1, 1 &lt;&lt; (index)); write_0xff(1, 1, nt_code[nt_buf[index] &amp; 0x7F] | (nt_buf[index] &amp; 0x80));</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">nt_buf_show_len_0</span><span class="params">(u8 pos, i32 num, u8 len)</span> &#123;</span><br><span class="line">	bit negative = num &lt; <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (negative) &#123;</span><br><span class="line">		num = -num;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (!num &amp;&amp; negative) &#123;</span><br><span class="line">			nt_buf[pos] = nt_mid;</span><br><span class="line">			negative = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			nt_buf[pos] = num % <span class="number">10</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		num /= <span class="number">10</span>;</span><br><span class="line">		pos--;</span><br><span class="line">	&#125; <span class="keyword">while</span> (--len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">nt_buf_show_len_blank</span><span class="params">(u8 pos, i32 num, u8 len)</span> &#123;</span><br><span class="line">	bit negative = num &lt; <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (negative) &#123;</span><br><span class="line">		num = -num;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		nt_buf[pos] = num % <span class="number">10</span>;</span><br><span class="line">		num /= <span class="number">10</span>;</span><br><span class="line">		pos--;</span><br><span class="line">	&#125; <span class="keyword">while</span> (--len &amp;&amp; num);</span><br><span class="line">	<span class="keyword">if</span> (negative) &#123;</span><br><span class="line">		nt_buf[pos] = nt_mid;</span><br><span class="line">		pos--;</span><br><span class="line">		len--;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">while</span> (len--) &#123;</span><br><span class="line">		nt_buf[pos] = nt_blank;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">nt_buf_show_dot_0</span><span class="params">(u8 pos, i32 num, u8 len, u8 dot_pos)</span> &#123;</span><br><span class="line">	nt_buf_show_len_0(pos, num, len);</span><br><span class="line">	nt_buf[dot_pos] |= <span class="number">0x80</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">nt_buf_show_dot_blank</span><span class="params">(u8 pos, i32 num, u8 len, u8 dot_pos)</span> &#123;</span><br><span class="line">	nt_buf_show_len_blank(pos, num, len);</span><br><span class="line">	nt_buf[dot_pos] |= <span class="number">0x80</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/****************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pcf_reg 0x41</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pcf_write</span><span class="params">(u8 ctrl, u8 dat)</span> &#123;</span><br><span class="line">	i2c_start();</span><br><span class="line">	i2c_send_byte(<span class="number">0x90</span>);</span><br><span class="line">	i2c_wait_ack();</span><br><span class="line">	i2c_send_byte(ctrl);</span><br><span class="line">	i2c_wait_ack();</span><br><span class="line">	i2c_send_byte(dat);</span><br><span class="line">	i2c_wait_ack();</span><br><span class="line">	i2c_stop();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> <span class="title function_">pcf_read</span><span class="params">(u8 ctrl)</span> &#123;</span><br><span class="line">	u8 recv_buffer;</span><br><span class="line">	i2c_start();</span><br><span class="line">	i2c_send_byte(<span class="number">0x90</span>);</span><br><span class="line">	i2c_wait_ack();</span><br><span class="line">	i2c_send_byte(ctrl);</span><br><span class="line">	i2c_wait_ack();</span><br><span class="line">	i2c_stop();</span><br><span class="line">	</span><br><span class="line">	i2c_start();</span><br><span class="line">	i2c_send_byte(<span class="number">0x91</span>);</span><br><span class="line">	i2c_wait_ack();</span><br><span class="line">	recv_buffer = i2c_recv_byte();</span><br><span class="line">	i2c_send_ack(<span class="number">0</span>);	<span class="comment">// <span class="doctag">TODO:</span> is 0?</span></span><br><span class="line">	i2c_stop();</span><br><span class="line">	<span class="keyword">return</span> recv_buffer * <span class="number">5.0f</span> / <span class="number">255.0f</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/****************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ds1302_reg_hour_r 0x85</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ds1302_reg_hour_w 0x84</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ds1302_reg_min_r 0x83</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ds1302_reg_min_w 0x82</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ds1302_reg_sec_r 0x81</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ds1302_reg_sec_w 0x80</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/****************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="type">float</span> <span class="title function_">temper_read</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	u8 recv_high, recv_low;</span><br><span class="line">	u16 res;</span><br><span class="line">	ds18b20_init();</span><br><span class="line">	ds18b20_write(<span class="number">0xCC</span>);</span><br><span class="line">	ds18b20_write(<span class="number">0x44</span>);</span><br><span class="line">	</span><br><span class="line">	ds18b20_init();</span><br><span class="line">	ds18b20_write(<span class="number">0xCC</span>);</span><br><span class="line">	ds18b20_write(<span class="number">0xBE</span>);</span><br><span class="line">	</span><br><span class="line">	recv_low = ds18b20_read() &amp; <span class="number">0x0F</span>;</span><br><span class="line">	recv_high = ds18b20_read();</span><br><span class="line">	res = recv_high;</span><br><span class="line">	res = (res &lt;&lt; <span class="number">8</span>) | recv_low;</span><br><span class="line">	<span class="keyword">return</span> res * <span class="number">0.0625f</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/****************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">e2prom_set_pos</span><span class="params">(u8 addr)</span> &#123;</span><br><span class="line">	i2c_start();</span><br><span class="line">	i2c_send_byte(<span class="number">0xA0</span>);</span><br><span class="line">	i2c_wait_ack();</span><br><span class="line">	i2c_send_byte(addr);</span><br><span class="line">	i2c_wait_ack();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">e2prom_write_byte</span><span class="params">(u8 dat)</span> &#123;</span><br><span class="line">	i2c_start();</span><br><span class="line">	i2c_send_byte(<span class="number">0xA0</span>);</span><br><span class="line">	i2c_wait_ack();</span><br><span class="line">	i2c_send_byte(dat);</span><br><span class="line">	i2c_send_ack(<span class="number">0</span>);</span><br><span class="line">	i2c_stop();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">u8 <span class="title function_">e2prom_read_byte</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	u8 temp;</span><br><span class="line">	i2c_start();</span><br><span class="line">	i2c_send_byte(<span class="number">0xA1</span>);</span><br><span class="line">	i2c_wait_ack();</span><br><span class="line">	temp = i2c_recv_byte();</span><br><span class="line">	i2c_send_ack(<span class="number">0</span>);</span><br><span class="line">	<span class="comment">// i2c_stop();</span></span><br><span class="line">	<span class="keyword">return</span> temp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/****************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> use_uart</span></span><br><span class="line"></span><br><span class="line">u8 uart_dat;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">uart_init</span><span class="params">(<span class="type">void</span>)</span>		<span class="comment">//9600bps@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">	SCON = <span class="number">0x50</span>;		<span class="comment">//8位数据,可变波特率</span></span><br><span class="line">	AUXR |= <span class="number">0x40</span>;		<span class="comment">//定时器1时钟为Fosc,即1T</span></span><br><span class="line">	AUXR &amp;= <span class="number">0xFE</span>;		<span class="comment">//串口1选择定时器1为波特率发生器</span></span><br><span class="line">	TMOD &amp;= <span class="number">0x0F</span>;		<span class="comment">//设定定时器1为16位自动重装方式</span></span><br><span class="line">	TL1 = <span class="number">0xC7</span>;			<span class="comment">//设定定时初值</span></span><br><span class="line">	TH1 = <span class="number">0xFE</span>;			<span class="comment">//设定定时初值</span></span><br><span class="line">	ET1 = <span class="number">0</span>;			<span class="comment">//禁止定时器1中断</span></span><br><span class="line">	TR1 = <span class="number">1</span>;			<span class="comment">//启动定时器1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">uart_send_byte</span><span class="params">(u8 dat)</span> &#123;</span><br><span class="line">	SBUF = dat;</span><br><span class="line">	<span class="keyword">while</span> (TI == <span class="number">0</span>);</span><br><span class="line">	TI = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">uart_int</span><span class="params">(<span class="type">void</span>)</span> interrupt 4 &#123;</span><br><span class="line">	<span class="keyword">if</span> (RI == <span class="number">1</span>) &#123;</span><br><span class="line">		uart_dat = SBUF;</span><br><span class="line">		RI = <span class="number">0</span>;</span><br><span class="line">		<span class="comment">// do sth...</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// use_uart</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/****************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/****************************************************************************/</span></span><br><span class="line"></span><br><span class="line">sbit sonic_tx = P1^<span class="number">0</span>;</span><br><span class="line">sbit sonic_rx = P1^<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> sonic_8_nops() _nop_(); _nop_(); _nop_(); _nop_(); _nop_(); _nop_(); _nop_(); _nop_();</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sonic_send_signal</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	u8 i;</span><br><span class="line">	<span class="comment">// 就是for (i = 1; i &lt; 8; ++i;)</span></span><br><span class="line">	<span class="comment">// 整个花活</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">1</span>; i; i &lt;&lt;= <span class="number">1</span>) &#123;</span><br><span class="line">		sonic_tx = <span class="number">1</span>;</span><br><span class="line">		sonic_8_nops();</span><br><span class="line">		sonic_tx = <span class="number">0</span>;</span><br><span class="line">		sonic_8_nops();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用timer0的版本</span></span><br><span class="line"><span class="comment">// 不使用timer0，需要你改造timer1的中断服务函数</span></span><br><span class="line"><span class="type">float</span> <span class="title function_">sonic_read</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	u16 dist;</span><br><span class="line">	<span class="comment">// 记得将timer0设置为12T模式</span></span><br><span class="line">	<span class="comment">// 忘了就立即推开启12T模式</span></span><br><span class="line">	sonic_send_signal();</span><br><span class="line">	TL0 = <span class="number">0</span>;</span><br><span class="line">	TH0 = <span class="number">0</span>;</span><br><span class="line">	TF0 = <span class="number">0</span>;</span><br><span class="line">	TR0 = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">while</span> ((sonic_rx == <span class="number">0</span>) &amp;&amp; (TF0 == <span class="number">0</span>));</span><br><span class="line">	TR0 = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (TF0 == <span class="number">0</span>) &#123;</span><br><span class="line">		dist = TH0;</span><br><span class="line">		dist = (dist &lt;&lt; <span class="number">8</span>) | TL0;</span><br><span class="line">		<span class="keyword">return</span> dist * (<span class="number">340.0</span> * <span class="number">100.0</span> * <span class="number">1e-6</span> / <span class="number">2.0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	TF0 = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">999.0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/****************************************************************************/</span></span><br><span class="line"></span><br><span class="line">u8 interface, interface_para;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">display</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	<span class="keyword">switch</span> (interface) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">			<span class="keyword">switch</span> (interface_para) &#123;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// led</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/****************************************************************************/</span></span><br><span class="line"></span><br><span class="line">u16 timer_key;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> key_pressed_judge() <span class="keyword">if</span> (key_pressed) return; key_pressed = 1;</span></span><br><span class="line"></span><br><span class="line">u8 <span class="title function_">keys_scan</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	u8 res = <span class="number">0xFF</span>;</span><br><span class="line">	P32 = <span class="number">1</span>; P33 = <span class="number">0</span>;</span><br><span class="line">	P42 = <span class="number">0</span>; P44 = <span class="number">0</span>;</span><br><span class="line">	delay_100us();</span><br><span class="line">	<span class="keyword">if</span> (P32 == <span class="number">0</span>)</span><br><span class="line">		res ^= <span class="number">0x04</span>;</span><br><span class="line">	P32 = <span class="number">0</span>; P33 = <span class="number">1</span>;</span><br><span class="line">	delay_100us();</span><br><span class="line">	<span class="keyword">if</span> (P33 == <span class="number">0</span>)</span><br><span class="line">		res ^= <span class="number">0x08</span>;</span><br><span class="line">	P32 = <span class="number">0</span>; P33 = <span class="number">0</span>;</span><br><span class="line">	P42 = <span class="number">1</span>; P44 = <span class="number">0</span>;</span><br><span class="line">	delay_100us();</span><br><span class="line">	<span class="keyword">if</span> (P42 == <span class="number">0</span>)</span><br><span class="line">		res ^= <span class="number">0x40</span>;</span><br><span class="line">	P42 = <span class="number">0</span>; P44 = <span class="number">1</span>;</span><br><span class="line">	delay_100us();</span><br><span class="line">	<span class="keyword">if</span> (P42 == <span class="number">0</span>)</span><br><span class="line">		res ^= <span class="number">0x80</span>;</span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">key_event</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	<span class="type">static</span> bit key_pressed = <span class="number">0</span>;</span><br><span class="line">	u8 key;</span><br><span class="line">	<span class="keyword">if</span> (timer_key &lt; <span class="number">100</span>)</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	timer_key = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	key = keys_scan();</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">switch</span> (key) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">0x7B</span>:		<span class="comment">// S5</span></span><br><span class="line">			key_pressed_judge();</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">0x77</span>:		<span class="comment">// S4</span></span><br><span class="line">			key_pressed_judge();</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">0xBB</span>:		<span class="comment">// S9</span></span><br><span class="line">			key_pressed_judge();</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">0xB7</span>:		<span class="comment">// S8</span></span><br><span class="line">			key_pressed_judge();</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			key_pressed = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/****************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">timer0_init</span><span class="params">(<span class="type">void</span>)</span>		<span class="comment">//100微秒@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">	AUXR &amp;= <span class="number">0x7F</span>;		<span class="comment">//定时器时钟12T模式</span></span><br><span class="line">	TMOD &amp;= <span class="number">0xF0</span>;		<span class="comment">//设置定时器模式</span></span><br><span class="line">	TL0 = <span class="number">0x9C</span>;			<span class="comment">//设置定时初值</span></span><br><span class="line">	TH0 = <span class="number">0xFF</span>;			<span class="comment">//设置定时初值</span></span><br><span class="line">	TF0 = <span class="number">0</span>;			<span class="comment">//清除TF0标志</span></span><br><span class="line">	<span class="comment">//TR0 = 1;			//定时器0开始计时</span></span><br><span class="line">	<span class="comment">//ET0 = 1;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">timer1_init</span><span class="params">(<span class="type">void</span>)</span>		<span class="comment">//1毫秒@12.000MHz</span></span><br><span class="line">&#123;</span><br><span class="line">	AUXR &amp;= <span class="number">0xBF</span>;		<span class="comment">//定时器时钟12T模式</span></span><br><span class="line">	TMOD &amp;= <span class="number">0x0F</span>;		<span class="comment">//设置定时器模式</span></span><br><span class="line">	TL1 = <span class="number">0x18</span>;			<span class="comment">//设置定时初值</span></span><br><span class="line">	TH1 = <span class="number">0xFC</span>;			<span class="comment">//设置定时初值</span></span><br><span class="line">	TF1 = <span class="number">0</span>;			<span class="comment">//清除TF1标志</span></span><br><span class="line">	TR1 = <span class="number">1</span>;			<span class="comment">//定时器1开始计时</span></span><br><span class="line">	ET1 = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	write_0xff(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0xFF</span>);</span><br><span class="line">	write_0x00(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0x00</span>);</span><br><span class="line">	write_0x00(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0x00</span>);</span><br><span class="line">	write_0xff(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0xFF</span>);</span><br><span class="line">	timer0_init();</span><br><span class="line">	timer1_init();</span><br><span class="line">	EA = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">update</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">	init();</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">		display();</span><br><span class="line">		update();</span><br><span class="line">		key_event();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/****************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">void timer0_int(void) interrupt 1 &#123;</span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">timer1_int</span><span class="params">(<span class="type">void</span>)</span> interrupt 3 &#123;</span><br><span class="line">	timer_key++;</span><br><span class="line">	</span><br><span class="line">	nt_index &amp;= <span class="number">0xF8</span>;		<span class="comment">// %= 8;</span></span><br><span class="line">	nt_show(nt_index);</span><br><span class="line">	nt_index++;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div><div class="article-licensing box"><div class="licensing-title"><p>蓝桥杯国赛</p><p><a href="https://jensentsts.github.io/2024/04/29/蓝桥杯国赛/">https://jensentsts.github.io/2024/04/29/蓝桥杯国赛/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>勇敢梧桐树</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2024-04-29</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2024-05-30</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/">嵌入式</a><a class="link-muted mr-2" rel="tag" href="/tags/%E7%AC%94%E8%AE%B0/">笔记</a></div><!--!--></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/img/eastereggs/nggyu.png" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/eastereggs/nggyu.png" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2024/03/21/%E4%BA%8C%E6%88%98%E8%93%9D%E6%A1%A5%E6%9D%AF/"><span class="level-item">二战蓝桥杯</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div class="content" id="valine-thread"></div><script src="//cdn.jsdelivr.net/npm/leancloud-storage@3/dist/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine@1.4.16/dist/Valine.min.js"></script><script>new Valine({
            el: '#valine-thread',
            appId: "7UVT2Wn1SqeS4e8BL5kOHopx-gzGzoHsz",
            appKey: "dVH6ChWtZCsbOIW2v9PsTI3M",
            placeholder: "止想想不如来说说",
            avatar: "mm",
            avatarForce: false,
            meta: ["nick","mail","link"],
            pageSize: 10,
            lang: "zh-CN",
            visitor: false,
            highlight: true,
            recordIP: false,
            
            
            
            enableQQ: false,
            requiredFields: [],
        });</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="槎游星海"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">槎游星海</p><p class="is-size-6 is-block">这世界，处处充满生机</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Earth</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">42</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">4</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">14</p></a></div></div></nav></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/blender/"><span class="level-start"><span class="level-item">blender</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/hexo/"><span class="level-start"><span class="level-item">hexo</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/"><span class="level-start"><span class="level-item">嵌入式</span></span><span class="level-end"><span class="level-item tag">15</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%95%B0%E5%AD%A6/"><span class="level-start"><span class="level-item">数学</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-04-29T11:32:22.000Z">2024-04-29</time></p><p class="title"><a href="/2024/04/29/%E8%93%9D%E6%A1%A5%E6%9D%AF%E5%9B%BD%E8%B5%9B/">蓝桥杯国赛</a></p><p class="categories"><a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/">嵌入式</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-03-21T14:24:50.000Z">2024-03-21</time></p><p class="title"><a href="/2024/03/21/%E4%BA%8C%E6%88%98%E8%93%9D%E6%A1%A5%E6%9D%AF/">二战蓝桥杯</a></p><p class="categories"><a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/">嵌入式</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-07-10T08:40:14.000Z">2023-07-10</time></p><p class="title"><a href="/2023/07/10/%E7%94%B5%E8%B5%9Bdebug%E9%9A%8F%E7%AC%94/">电赛debug随笔</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-06-13T11:41:51.000Z">2023-06-13</time></p><p class="title"><a href="/2023/06/13/STM32SPWM/">STM32SPWM</a></p><p class="categories"><a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/">嵌入式</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-05-29T11:48:28.000Z">2023-05-29</time></p><p class="title"><a href="/2023/05/29/STM32PWM/">STM32PWM</a></p><p class="categories"><a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/">嵌入式</a></p></div></article></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/blender/"><span class="tag">blender</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cpp/"><span class="tag">cpp</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hexo/"><span class="tag">hexo</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/python/"><span class="tag">python</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8D%9A%E5%AE%A2/"><span class="tag">博客</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/"><span class="tag">嵌入式</span><span class="tag">18</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%BC%80%E5%8F%91/"><span class="tag">开发</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%95%B0%E5%AD%A6/"><span class="tag">数学</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9D%82%E8%B0%88/"><span class="tag">杂谈</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%B1%87%E7%BC%96/"><span class="tag">汇编</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%B8%B8%E6%88%8F/"><span class="tag">游戏</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%94%B5%E8%B5%9B/"><span class="tag">电赛</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%AC%94%E8%AE%B0/"><span class="tag">笔记</span><span class="tag">16</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%95%BF%E6%9C%9F%E6%9B%B4%E6%96%B0/"><span class="tag">长期更新</span><span class="tag">5</span></a></div></div></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#致谢"><span class="level-left"><span class="level-item">1</span><span class="level-item">致谢</span></span></a></li><li><a class="level is-mobile" href="#省赛回顾"><span class="level-left"><span class="level-item">2</span><span class="level-item">省赛回顾</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#比赛前"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">比赛前</span></span></a></li><li><a class="level is-mobile" href="#比赛时"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">比赛时</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#To-begin-with"><span class="level-left"><span class="level-item">2.2.1</span><span class="level-item">To begin with</span></span></a></li><li><a class="level is-mobile" href="#Taking-a-further-step"><span class="level-left"><span class="level-item">2.2.2</span><span class="level-item">Taking a further step</span></span></a></li><li><a class="level is-mobile" href="#Eventually"><span class="level-left"><span class="level-item">2.2.3</span><span class="level-item">Eventually</span></span></a></li><li><a class="level is-mobile" href="#Alongside"><span class="level-left"><span class="level-item">2.2.4</span><span class="level-item">Alongside</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#代码风格"><span class="level-left"><span class="level-item">3</span><span class="level-item">代码风格</span></span></a></li><li><a class="level is-mobile" href="#新的资源"><span class="level-left"><span class="level-item">4</span><span class="level-item">新的资源</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#ds18b20勘误"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">ds18b20勘误</span></span></a></li><li><a class="level is-mobile" href="#特殊的按键扫描办法"><span class="level-left"><span class="level-item">4.2</span><span class="level-item">特殊的按键扫描办法</span></span></a></li><li><a class="level is-mobile" href="#串口通讯"><span class="level-left"><span class="level-item">4.3</span><span class="level-item">串口通讯</span></span></a></li><li><a class="level is-mobile" href="#超声波"><span class="level-left"><span class="level-item">4.4</span><span class="level-item">超声波</span></span></a></li><li><a class="level is-mobile" href="#红外"><span class="level-left"><span class="level-item">4.5</span><span class="level-item">红外</span></span></a></li><li><a class="level is-mobile" href="#继电器"><span class="level-left"><span class="level-item">4.6</span><span class="level-item">继电器</span></span></a></li></ul></li><li><a class="level is-mobile" href="#刷题"><span class="level-left"><span class="level-item">5</span><span class="level-item">刷题</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#模板"><span class="level-left"><span class="level-item">5.1</span><span class="level-item">模板</span></span></a></li><li><a class="level is-mobile" href="#TH11"><span class="level-left"><span class="level-item">5.2</span><span class="level-item">TH11</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#代码"><span class="level-left"><span class="level-item">5.2.1</span><span class="level-item">代码</span></span></a></li></ul></li><li><a class="level is-mobile" href="#TH12"><span class="level-left"><span class="level-item">5.3</span><span class="level-item">TH12</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#代码-1"><span class="level-left"><span class="level-item">5.3.1</span><span class="level-item">代码</span></span></a></li></ul></li><li><a class="level is-mobile" href="#TH13"><span class="level-left"><span class="level-item">5.4</span><span class="level-item">TH13</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#代码特点"><span class="level-left"><span class="level-item">5.4.1</span><span class="level-item">代码特点</span></span></a></li><li><a class="level is-mobile" href="#代码-2"><span class="level-left"><span class="level-item">5.4.2</span><span class="level-item">代码</span></span></a></li></ul></li><li><a class="level is-mobile" href="#TH14"><span class="level-left"><span class="level-item">5.5</span><span class="level-item">TH14</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#代码-3"><span class="level-left"><span class="level-item">5.5.1</span><span class="level-item">代码</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#模拟训练实录"><span class="level-left"><span class="level-item">6</span><span class="level-item">模拟训练实录</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#手搓框架"><span class="level-left"><span class="level-item">6.1</span><span class="level-item">手搓框架</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="勇敢梧桐树" height="28"></a><p class="is-size-7"><span>&copy; 2024 勇敢梧桐树</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">© 2021-2024</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>